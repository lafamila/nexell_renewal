{% extends 'common/main_base.html' %}
{% block content %}

<style type="text/css">
tbody .btnUpdate, tbody .btn{
    line-height: 0.3!important;
}
    tbody{
        font-size:12px!important;
    }
    .table-bordered, .table-bordered>tbody>tr>td, .table-bordered>tbody>tr>th, .table-bordered>tfoot>tr>td, .table-bordered>tfoot>tr>th, .table-bordered>thead>tr>td, .table-bordered>thead>tr>th {
        border: 1px solid #111;
    }

    .table>tbody>tr>td, .table>tbody>tr>th, .table>tfoot>tr>td, .table>tfoot>tr>th, .table>thead>tr>td, .table>thead>tr>th {
        line-height: 0.85!important;
    }

</style>
<!--########################################################################-->
<!--# RIBBON area start                                                    #-->
<!--########################################################################-->
<div id="ribbon" style="background:#B3E5FC!important;">
	<span class="ribbon-button-alignment">
		<span class="btn btn-ribbon"><i class="fa fa-refresh"></i></span>
	</span>
    <ol class="breadcrumb" style="font-size:14px !important;">
<!--		<li>홈</li><li>계약 및 프로젝트</li><li>계약 및 프로젝트 등록</li>-->
        <style>
            .breadcrumb>li+li:before {
                content: ">";
                color : #374850!important;
            }
        </style>
        <li style="font-size:17px !important;color:#1565C0!important;">근태현황관리 </li><li><span> 종합관리</span></li>
	</ol>
</div>
<!--########################################################################-->
<!--# RIBBON area end                                                      #-->
<!--########################################################################-->


<!--########################################################################-->
<!--# contents area start                                                  #-->
<!--########################################################################-->
<div id="content">

	<!-- 화면 제목 -->
	<div class="row">
		<div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
<!--
			<h1 class="page-title txt-color-blueDark">
				<i class="fa-fw fa fa-list-alt"></i>
					목표 관리 <span>> 기성</span>
			</h1>
-->
		</div>
		<!-- right side of the page with the sparkline graphs -->
		<div class="col-xs-12 col-sm-5 col-md-5 col-lg-8">
		</div>
	</div>

	<!-- 화면 설명 -->
<!--
	<div class="alert alert-block alert-info" style="background:#e6faff!important;">
		<p><i class="fa-fw fa fa-info"></i>
			재무상태현황을 관리합니다.
		</p>
	</div>
-->

	<!-- 화면 내용 -->
	<section id="widget-grid">

		<div class="row">
			<article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

				<!-- Widget ID (each widget will need unique ID)-->
				<div class="jarviswidget jarviswidget-color-darken">
					<header>
						<span class="widget-icon"> <i class="fa fa-list"></i> </span>
                        <h2><span id="year">2020</span>년 근태현황</h2>
						<div class="widget-toolbar">
                            <input type="text" id="s_year" name="s_year" style="color:#333;"/><button type="button" class="btn btn-info" id="s_submit">검색</button>
							<!-- <button type="button" class="btn btn-warning" data-toggle="modal" href="#popBox1" data-action="insert"><i class="fa fa-plus"> 등록</i></button> -->
							<button type="button" class="btn btn-success" id="btnExcel"><i class="fa fa-file-excel-o"> 엑셀 다운로드</i></button>
							<button type="button" class="btn btn-info" id="btnScreen"><i class="fa fa-print"> 출력 </i></button>
						</div>
						<div class="widget-toolbar">
						</div>
					</header>
					<!-- widget body div-->
					<div>
						<!-- widget edit box -->
						<div class="jarviswidget-editbox">
						</div>
						<!-- end widget edit box -->
						<style>
                            .table>tbody>tr>td, .table>tbody>tr>th, .table>tfoot>tr>td, .table>tfoot>tr>th, .table>thead>tr>td, .table>thead>tr>th {
                                line-height: 0.95!important;
                            }
                            .colorB{
                                background:rgb(146, 205, 220);
                                font-weight: bold;
                            }
                            .tot{
                                background:rgb(255,153,204);
                                font-weight: bold;
                            }
                            .sub_tot{
                                background:#e6faff!important;
                                font-size:12px!important;
                                font-weight: 600!important;
                            }
                            .bold{
                                font-size:12px!important;
                                font-weight: 600!important;
                            }
                            .colorG {
                                background: rgb(204,255,204)!important;
                            }
                            .colorY {
                                background: #FDFD96!important;
                            }
                            .table>thead+tbody, .table>tbody+tbody {
                                border-top: 2px solid #000;
                            }
                            #dtList1{
								border: 2px solid #666!important;
							}
                            .bottom_border{

                                border-bottom: 2px solid #666!important;
                            }
                            .right_border{
                                border-right: 2px solid #666!important;
                            }
                            .no-padding>table tr:last-child th:last-child {
                                border-right: 2px solid #666!important;
                            }
                            .colored{
                                background:rgb(255,204,153)!important;
                            }

                        </style>
                        <script>

                        </script>
						<!-- widget content -->
						<div class="widget-body no-padding">
							<table class="table table-bordered w100p floating-thead" id="dtList1">
								<colgroup>
									<col width="60">
									<col width="60">
									<col width="90">
									<col width="60">
									<col width="60">
									<col width="60">
									<col width="60">
									<col width="60">
									<col width="60">
									<col width="240">
									<col width="240">
									<col width="180">
<!--									<col width="130">-->

								</colgroup>
								<thead>
									<!-- 헤더 -->
									<tr>
										<th class="colorB bottom_border" style="text-align:center;vertical-align:middle;" rowspan="2">부서</th>
										<th class="colorB bottom_border" style="text-align:center;vertical-align:middle;" rowspan="2">직위</th>
										<th class="colorB right_border bottom_border" style="text-align:center!important;vertical-align:middle;" rowspan="2">성명</th>
										<th class="tot right_border bottom_border" style="text-align:center!important;vertical-align:middle;" rowspan="2">지&nbsp;&nbsp;&nbsp;각<br>(연간누계)</th>
										<th class="colorB right_border" style="text-align:center!important;" colspan="5">휴가</th>
										<th class="colorG bottom_border" style="text-align:center!important;vertical-align:middle;" rowspan="2">일반휴가 사용날짜</th>
										<th class="colorG bottom_border" style="text-align:center!important;vertical-align:middle;" rowspan="2">반차 사용날짜</th>
										<th class="colorG bottom_border" style="text-align:center!important;vertical-align:middle;" rowspan="2">기타</th>
									</tr>
									<tr>
										<th class="colorB bottom_border" style="text-align:center;">총휴가일</th>
										<th class="colorB bottom_border" style="text-align:center;">여름휴가</th>
										<th class="colorB bottom_border" style="text-align:center;">일반휴가</th>
										<th class="colorB bottom_border" style="text-align:center;">반차</th>
										<th class="color-contract right_border bottom_border" style="text-align:center;">잔여<br>휴가일</th>
									</tr>
                                </thead>
                                <tbody role='exec'>
                                    {% for i in range(1, 31) %}
                                    <tr id="row{{i}}" data-name="{{i}}">
                                        <td class="colorG" style="text-align:center;" name="dept">&nbsp;</td>
                                        <td class="colorG" style="text-align:center;" name="level"></td>
                                        <td class="colorY right_border colorBtn" style="text-align:center;" name="name"></td>
                                        <td class="text-number right_border" name="late"></td>
                                        <td class="text-number" name="total"></td>
                                        <td class="text-number" name="summer"></td>
                                        <td class="text-number" name="ordinary"></td>
                                        <td class="text-number" name="half"></td>
                                        <td class="text-number right_border" name="remain"></td>
                                        <td class="text-left" name="special"></td>
                                        <td class="text-left" name="remark"></td>
                                        <td class="text-left" name="new_remark"></td>
                                    </tr>

                                    {% endfor %}
                                </tbody>
                            </table>
						</div>
						<!-- end widget content -->
					</div>
					<!-- end widget body div -->
				</div>
				<!-- end widget -->

			</article>
		</div>

	</section>

</div>
<!--########################################################################-->
<!--# contents area end                                                    #-->
<!--########################################################################-->


<!--########################################################################-->
<!--# commom script start                                                  #-->
<!--########################################################################-->
<script type="text/javascript">
/******************************************************************************
 *
 */
getWork = function(work_year)
{
    $("#dtList1").find("tbody[role=exec]").find("td").html('');
    $("#dtList1").find("tbody[role=exec]").find("td[name=dept]").html('&nbsp;');
	var params = '';
	params += '&work_year='+work_year;
	$.ajax({
		url: '/api/work/ajax_get_work',
		type: 'GET',
		data: params,
		dataType: 'json',
		contentType: false,
		processData: false,
		success: function(pResult) {
			console.log(pResult);
            var pData = pResult.data;
            $.each(pData, function(pIndex, pValue){
                console.log(pValue);
                if(pValue.work_month == 'late' || pValue.work_month == 'total' || pValue.work_month == 'summer' || pValue.work_month == 'ordinary'){
                    var data = parseInt(pValue.work_data);
                    if(isNaN(data)) data = 0;
                    if(data == 0){
                        data = '';
                    }
                    else{
                        data = data + '';
                    }
                    $("#"+pValue.work_row).find("td[name="+pValue.work_month+"]").html(data.toFormat('NUMBER'));

                }
                else if(pValue.work_month == 'half'){
                    var data = parseFloat(pValue.work_data);
                    if(isNaN(data)) data = 0.0;
                    if(data == 0.0){
                        $("#"+pValue.work_row).find("td[name="+pValue.work_month+"]").html('');
                    }
                    else{
                        $("#"+pValue.work_row).find("td[name="+pValue.work_month+"]").html(data.toFixed(1));
                    }

                }
                else{
                    $("#"+pValue.work_row).find("td[name="+pValue.work_month+"]").html(pValue.work_data);
                    $("#"+pValue.work_row).find("td[name="+pValue.work_month+"]").data("state", pValue.memo_state);
                    $("#"+pValue.work_row).find("td[name="+pValue.work_month+"]").data("sn", pValue.memo_sn);
                    if(pValue.work_month == 'name' && pValue.memo_state == 1){
                        $("#"+pValue.work_row).find("td[name="+pValue.work_month+"]").addClass("colored");
                    }
                }
            });

            calcTotal();
            $("#year").html(work_year);
		}
	});
}



calcTotal = function()
{
    var trs = $("#dtList1").find("tbody[role=exec]").find("tr");
    $.each(trs, function(pIndex, pValue){
        var tr = $(pValue);
        var total = $(tr).find("td[name=total]").html();
        var summer = $(tr).find("td[name=summer]").html();
        var ordinary = $(tr).find("td[name=ordinary]").html();
        var half = $(tr).find("td[name=half]").html();

        if(total == '' && summer == '' && ordinary == '' && half == ''){
            return;
        }

        total = total == '' ? 0.0 : parseFloat(total);
        summer = summer == '' ? 0.0 : parseFloat(summer);
        ordinary = ordinary == '' ? 0.0 : parseFloat(ordinary);
        half = half == '' ? 0.0 : parseFloat(half);
        var remain = total - summer - ordinary - half;

        $(tr).find("td[name=remain]").html(remain.toFixed(1));
//        if($(tr).find("td[name=name]").hasClass("colored")){
//            $(tr).find("td[name=summer]").addClass("colored");
//            $(tr).find("td[name=ordinary]").addClass("colored");
//            $(tr).find("td[name=half]").addClass("colored");
//            $(tr).find("td[name=late]").addClass("colored");
//        }
//        else{
//            $(tr).find("td[name=summer]").removeClass("colored");
//            $(tr).find("td[name=ordinary]").removeClass("colored");
//            $(tr).find("td[name=half]").removeClass("colored");
//            $(tr).find("td[name=late]").removeClass("colored");
//
//        }
    });
}

insertWork = function(work_year, work_row, work_month, work_data)
{
	var params = '';
	params += '&work_year='+work_year;
	params += '&work_row='+work_row;
	params += '&work_month='+work_month;
	params += '&work_data='+work_data;
    console.log(params);
	$.ajax({
		url: '{base_url}work/ajax_insert_work',
		type: 'GET',
		data: params,
		dataType: 'json',
		contentType: false,
		processData: false,
		validate: function() {
			return true;
		},
		success: function(pResult) {
            calcTotal();
		}
	});
}

insertMemo = function(work_row, memo_state)
{
	var params = '';
	params += '&work_row='+work_row;
	params += '&memo_state='+memo_state;
    console.log(params);
	$.ajax({
		url: '{base_url}work/ajax_insert_memo',
		type: 'GET',
		data: params,
		dataType: 'json',
		contentType: false,
		processData: false,
		validate: function() {
			return true;
		},
		success: function(pResult) {
            location.reload();
		}
	});
}

updateMemo = function(work_row, memo_sn, memo_state)
{
	var params = '';
	params += '&memo_sn='+memo_sn;
	params += '&memo_state='+memo_state;
    console.log(params);
	$.ajax({
		url: '{base_url}work/ajax_update_memo',
		type: 'GET',
		data: params,
		dataType: 'json',
		contentType: false,
		processData: false,
		validate: function() {
			return true;
		},
		success: function(pResult) {
            if(memo_state==1){

                $(document).find("#"+work_row).find("td[name=name]").addClass("colored");
//                $(document).find("#"+work_row).find("td[name=summer]").addClass("colored");
//                $(document).find("#"+work_row).find("td[name=ordinary]").addClass("colored");
//                $(document).find("#"+work_row).find("td[name=half]").addClass("colored");
//                $(document).find("#"+work_row).find("td[name=late]").addClass("colored");
            }
            else{
                $(document).find("#"+work_row).find("td[name=name]").removeClass("colored");
//                $(document).find("#"+work_row).find("td[name=summer]").removeClass("colored");
//                $(document).find("#"+work_row).find("td[name=ordinary]").removeClass("colored");
//                $(document).find("#"+work_row).find("td[name=half]").removeClass("colored");
//                $(document).find("#"+work_row).find("td[name=late]").removeClass("colored");

            }
            $.each($(document).find("#"+work_row).find("td"), function(pI, pTag){
                $(pTag).data("state", memo_state);
            });
		}
	});
}

$(document).on('dblclick', "td[name=dept],td[name=level], td[name=name], td[name=late], td[name=total], td[name=summer], td[name=ordinary], td[name=half], td[name=special], td[name=remark], td[name=new_remark]", function(pEvent){
    var loginid = $('#loginID').val();
    if(loginid != 'ma_keunmi' && loginid != 'rachel' && loginid != 'nexelll'){
        alert("권한이 없습니다.");
        return;
    }
    var year = $("#s_year").val();
    var row = $(this).parent().attr('id');
    var month = $(this).attr('name');
    var data = $(this).html().replaceAll(',', '');
    if(data == '&nbsp;'){
        data = '';
    }
    var inputValue = prompt('값을 입력하세요.', data);
    inputValue = inputValue.replaceAll(',', '');
    if (inputValue != null && inputValue != data) {

        if(month == 'late' || month == 'total' || month == 'summer' || month == 'ordinary'){
            if(parseInt(inputValue) != 0)
                $(this).html(inputValue.toString().toFormat('NUMBER'));
            else{
                $(this).html('');
                inputValue = 0;
            }
            insertWork(year, row, month, inputValue);
        }
        else if(month == 'half'){
            if(parseFloat(inputValue) != 0.0)
                $(this).html(parseFloat(inputValue).toFixed(1));
            else{
                $(this).html('');
                inputValue = 0;
            }
            insertWork(year, row, month, inputValue);

        }
        else{
            if(inputValue == ''){
                $(this).html('&nbsp;');
            }
            else
                $(this).html(inputValue);
            insertWork(year, row, month, inputValue);
        }

    }

});

var timer;
$(document).on('click', ".colorBtn", function(pEvent){
    var row = $(this).parent().attr('id');
    var data = $(this).html().replaceAll(',', '');
    var _class = $(this).hasClass('colored');
    var loginid = $('#loginID').val();
    var state = parseInt($(this).data("state"));
    var sn = parseInt($(this).data("sn"));
    if(data == '&nbsp;'){
        data = '';
    }
    if (timer) {
        clearTimeout(timer);
        timer = null;
    }
    else{
        timer = setTimeout(function() {
            if(loginid == 'ma_keunmi' || loginid == 'rachel'){
                if(data != ''){
                    if(_class){
                        updateMemo(row, sn, 0);

                    }
                    else{
                        if(state == -1){
                            insertMemo(row, 1);
                        }
                        else{
                            updateMemo(row, sn, 1);
                        }
                    }
                }

            }
            else{
                alert("권한이 없습니다.");
            }

            clearTimeout(timer);
            timer = null;
        }, 250);

    }

});

$(document).on('click', "#s_submit", function(pEvent){

    var year = $("#s_year").val();
	getWork(year);

});
$(document).on('click', '#btnScreen', function(e) {
	window.print();
});
$(document).on('click', '#btnExcel', function(e) {
    var postfix = $("#s_year").val();
    var fileName = "근태관리현황_"+postfix+".xls";
    var a = document.createElement('a');
    var data_type = 'data:application/vnd.ms-excel';
    var table_html = '';
    var tbl = 'dtList1';
//    $.each(tbls, function(tblIdx, tbl){


//        $trs = $(tbl).find('tr');
//        $.each($trs, function(pI, tr){
//            $tds = $(tr).find('td');
//            $.each($tds, function(i, td){
//                var idx = i;
//                if($(td).attr('rowspan') > 0){
//                    $(td).attr('rowspan', 1);
//                }
//                else if($(td).css('display') == 'none'){
//                    console.log("else : ", idx);
//                    if(idx == 6 || idx == 7 || idx==11){
//                        $(td).show();
//                        $(td).html('0');
//                    }
//                    else{
//                        $(td).show();
//
//                    }
//                }
//            });
//        });


        var table_div = document.getElementById(tbl);

        table_html += table_div.outerHTML.replace(/ /g, '%20');
//    });
    a.href = data_type + ',%EF%BB%BF' + table_html;
    a.download = fileName;
    a.click();
	getWork(postfix);

//    getReportExpectSales2($('#popReport3').find('#r3_s_ddt_man').val());

    e.preventDefault();



});

</script>
<script type="text/javascript">
$(function () {
  $('table.floating-thead').each(function() {
    if( $(this).css('border-collapse') == 'collapse') {
      $(this).css('border-collapse','separate').css('border-spacing',0);
    }
    $(this).prepend( $(this).find('thead:first').clone().hide().css('top',160).css('position','fixed') );
  });

  $(window).scroll(function() {
    var scrollTop = $(window).scrollTop(),
      scrollLeft = $(window).scrollLeft();
    $('table.floating-thead').each(function(i,v) {
      var thead = $(this).find('thead:last'),
        clone = $(this).find('thead:first'),
        top = $(this).offset().top,
        bottom = top + $(this).height() - thead.height();

      if( scrollTop < top-180 || scrollTop > bottom ) {
        clone.hide();
        return true;
      }
      if( clone.is('visible') ) return true;
      var fixP = 0;
      clone.find('th').each(function(i) {
        if(thead.find('th').eq(i).html() == '계'){
            fixP = -1;
        }
        $(this).width( thead.find('th').eq(i).width() +fixP);
        console.log(fixP);
      });
      clone.css("margin-left", -scrollLeft ).width( thead.width() ).show();
    });
  });
});

$(function() {
	/**************************************************************************
     *
     */
    //$('#dtList1 tbody').yRowspan(0);
    var year = new Date().getFullYear();
    $("#s_year").val(year);
	getWork(year);
});
</script>

{% endblock %}
