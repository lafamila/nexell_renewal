{% extends 'common/main_base.html' %}
{% block content %}

<!--########################################################################-->
<!--# contents style end                                                   #-->
<!--########################################################################-->

<style type="text/css">
tbody .btnUpdate, tbody .btn{
    line-height: 0.3!important;
}
    tbody{
        font-size:12px!important;
    }
    .table>tbody>tr>td, .table>tbody>tr>th, .table>tfoot>tr>td, .table>tfoot>tr>th, .table>thead>tr>td, .table>thead>tr>th {
        line-height: 0.95!important;
    }
</style>
<!--########################################################################-->
<!--# RIBBON area start                                                    #-->
<!--########################################################################-->
<div id="ribbon" style="background:#B3E5FC!important;">
	<span class="ribbon-button-alignment">
		<span class="btn btn-ribbon"><i class="fa fa-refresh"></i></span>
	</span>
    <ol class="breadcrumb" style="font-size:14px !important;">
<!--		<li>홈</li><li>계약 및 프로젝트</li><li>계약 및 프로젝트 등록</li>-->
        <style>
            .breadcrumb>li+li:before {
                content: ">";
                color : #374850!important;
            }
        </style>
        <li style="font-size:17px !important;color:#1565C0!important;">목표/장려금관리</li><li><span> 운영 관리</span></li>
	</ol>



</div>
<!--########################################################################-->
<!--# RIBBON area end                                                      #-->
<!--########################################################################-->


<!--########################################################################-->
<!--# contents area start                                                  #-->
<!--########################################################################-->
<div id="content">

	<!-- 화면 제목 -->
	<div class="row">
		<div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
<!--
			<h1 class="page-title txt-color-blueDark">
				<i class="fa-fw fa fa-list-alt"></i>
					목표 관리 <span>> 기성</span>
			</h1>
-->
		</div>

		<!-- right side of the page with the sparkline graphs -->
		<div class="col-xs-12 col-sm-5 col-md-5 col-lg-8">
		</div>
	</div>

	<!-- 화면 설명 -->
<!--
	<div class="alert alert-block alert-info" style="background:#e6faff!important;">
		<p><i class="fa-fw fa fa-info"></i>
			월별 수주 계획을 관리합니다.
		</p>
	</div>
-->

	<!-- 화면 내용 -->
	<section id="widget-grid">

		<div class="row">
			<article class="">

				<!-- Widget ID (each widget will need unique ID)-->
				<div class="jarviswidget jarviswidget-color-darken">
                    <script>


                    </script>
					<header>
						<span class="widget-icon"> <i class="fa fa-list"></i> </span>
                        <h2>개인별 목표</h2>
						<div class="widget-toolbar">
							<button type="button" class="btn btn-success" id="btnExcel"><i class="fa fa-file-excel-o"> 엑셀 다운로드</i></button>
						</div>


					</header>
					<!-- widget body div-->
					<div>
						<!-- widget edit box -->
						<div class="jarviswidget-editbox">
						</div>
						<!-- end widget edit box -->
						<style>
                            .bottom_border{

                                border-bottom: 2px solid #666!important;
                            }
                            .top_border{

                                border-top: 2px solid #666!important;
                            }
                            .right_border{
                                border-right: 2px solid #666!important;
                            }

                            .left_border{
                                border-left: 2px solid #666!important;
                            }
                            #dtList1{
								border: 1px solid #666!important;
							}

                            #dtList1 tbody, #dtList1 thead tr{
                                font-size: 11px!important;
                            }
                            .colorEG{
                                background:rgb(255,204,153)!important;
                                font-weight: bold;
                            }
                            .colorJ{
                                background:#3d8b40!important;
                                font-weight: bold;
                                color:white;
                            }
                            .colorSky{
                                background:rgb(146, 205, 220);
                                font-weight: bold;
                            }
                            .tot{
                                background:rgb(255,153,204);
                                font-weight: bold;
                            }
                            .sub_tot{
                                background:#e6faff!important;
                                font-size:8px!important;
                                font-weight: 600!important;
                            }
                            .bold{
                                font-size:11px!important;
                                font-weight: 600!important;
								text-overflow: ellipsis!important;
								overflow: hidden;
								white-space: nowrap;
                            }
                            .colorG {
                                background: rgb(204,255,204)!important;
                            }
/*
                            .colorY {
                                background: #FDFD96!important;
                            }
*/
                            .table>tbody+tbody {
                                border-top: 2px solid #666;
                            }
                            .table>thead+tbody {
                                border-top: 2px solid #666;
                            }
                            .middle{
                                vertical-align: middle!important;
                            }
                            @media (min-width: 100px) and (max-width: 1024px) {


                                body.smart-style-6 #content{
                                        margin-left: 0px;
                                        padding:30px 0px;
                                }
                            }
                            .jarviswidget>div{
                                font-size:12px!important;
                            }
                            .colored{
                                background: #FFFF00!important   ;
                            }
                            .coloredRed{
                                background: rgb(255,153,204)!important;
                            }
                            .jarviswidget>div {
                                border-right-color: transparent!important;
                            }
							.no-padding-3{
								padding-right:3px!important;
								padding-left:3px!important;
							}
                        </style>
						<!-- widget content -->
						<div class="widget-body no-padding">
							<table class="datatable table table-bordered table-hover" id="dtList1">
								<colgroup>
									<col width="1.8%">
									<col width="3.2%">
									<col width="5.5%">
									<col width="5.5%">
									<col width="*">
									<col width="5.5%">
									<col width="5.5%">
									<col width="5.5%">
									<col width="5.5%">
									<col width="5.5%">
									<col width="5.5%">
									<col width="5.5%">
									<col width="5.5%">
									<col width="5.5%">
									<col width="5.5%">
									<col width="5.5%">
									<col width="5.5%">
									<col width="5.5%">
								</colgroup>
								<thead>
									<!-- 헤더 -->
									<tr>
										<th colspan="18">
                                            <ul class="nav nav-tabs" id="popEditTabs">
                                                <input type="hidden" name="s_amt_ty_code" id="s_amt_ty_code"/>
                                                {% for i, code in enumerate(amt_ty_code_list) %}

                                                <li data-action="{{code.value}}">
                                                    <a data-toggle="tab" href="#tabBox{{code.value}}" data-action="tab{{code.value}}"><i class="fa fa-lg fa-list"></i>&nbsp;<span>{{code.label}}</span></a>
                                                </li>
												{% endfor %}

                                            </ul>
										</th>
									</tr>
                                    <tr>
										<th class="search">검색</th>
										<th class="hasinput">
											<input type="text" class="form-control" placeholder="[년도]" id="s_year" name="s_year">
										</th>
										<th class="hasinput">
											<select class="form-control select2 w100p" id="s_dept_code" name="s_dept_code">
												<option value="">[전체]</option>
												{% for code in dept_code_list %}
												<option value="{{code.value}}">{{code.label}}</option>
												{% endfor %}
											</select>
										</th>
										<th class="hasinput">
											<select class="form-control select2 w100p" id="s_mber_sn" name="s_mber_sn">
												<option value="">[전체]</option>
												{% for code in member_list %}
												<option value="{{code.value}}">{{code.label}}</option>
												{% endfor %}
											</select>
										</th>
										<th class="hasinput">
											<input type="text" class="form-control" placeholder="[전체]" id="s_spt_nm" name="s_spt_nm">
										</th>
										<th class="" style="color:red!important;" colspan="14">
											&nbsp;※ 목표 금액은 VAT가 포함된 원 단위 금액입니다.
										</th>
									</tr>
									<tr>
										<th style="text-align:center!important;">No.</th>
										<th style="text-align:center!important;">년도</th>
										<th style="text-align:center!important;">부서</th>
										<th style="text-align:center!important;">사원</th>
										<th style="text-align:center!important;">현장명</th>
										<th style="text-align:center!important;">1월</th>
										<th style="text-align:center!important;">2월</th>
										<th style="text-align:center!important;">3월</th>
										<th style="text-align:center!important;">4월</th>
										<th style="text-align:center!important;">5월</th>
										<th style="text-align:center!important;">6월</th>
										<th style="text-align:center!important;">7월</th>
										<th style="text-align:center!important;">8월</th>
										<th style="text-align:center!important;">9월</th>
										<th style="text-align:center!important;">10월</th>
										<th style="text-align:center!important;">11월</th>
										<th style="text-align:center!important;">12월</th>
										<th style="text-align:center!important;">계</th>
<!--										<th style="text-align:center!important;">합계</th>-->
									</tr>
								</thead>
                                <tbody>


                                </tbody>
                            </table>
						</div>
						<!-- end widget content -->
					</div>
					<!-- end widget body div -->
				</div>
				<!-- end widget -->

			</article>
		</div>

	</section>

</div>
<!--########################################################################-->
<!--# contents area end                                                    #-->
<!--########################################################################-->


<!--########################################################################-->
<!--# commom script start                                                  #-->
<!--########################################################################-->
<script>
getGoals = function(){

    $.datatable1 = $('#dtList1').DataTable({
		serverSide: true,
		ordering: false,
		pageLength: 30,
        ajax: {
            url: '/api/goal/ajax_get_goals_datatable',
            type: 'POST',
            data: function(params) {
				return $.extend({}, params, {
					's_year': $('#dtList1').find('#s_year').val(),
					's_amt_ty_code': $('#dtList1').find('#s_amt_ty_code').val(),
					's_dept_code': $('#dtList1').find('#s_dept_code').val(),
					's_mber_sn': $('#dtList1').find('#s_mber_sn').val(),
					's_spt_nm': $('#dtList1').find('#s_spt_nm').val(),
				});
            },
            error: function(pJqXHR, pTextStatus, pErrorThrown) {
                toastrError(pJqXHR);
            }
        },
		createdRow: function (row, data, dataIndex) {
            $(row).attr('data-year', data.stdyy);
            $(row).attr('data-amt', data.amt_ty_code);
            $(row).attr('data-mber', data.mber_sn);
            $(row).attr('data-cntrct', data.cntrct_sn);
			$(row).find("td.input-available").each(function(pIndex, pCol){
				$(pCol).attr("data-col", (pIndex+1)+"m");
			});
        },
		order: [1, 'asc'],
        columns: [
            { data: 'stdyy', className: 'text-center', orderable: false,
                render: function(data, type, row, meta) {
                    return meta.settings._iDisplayStart + meta.row + 1;
                }
            },
			{ data: 'stdyy' },
			{ data: 'dept_nm' },
			{ data: 'mber_nm' },
			{ data: 'spt_nm' },
			{ data: '1m', className: 'text-right input-available',
				render: function(data, type, row, meta) {
					return data.toString().toFormat('NUMBER');
				}
			},
			{ data: '2m', className: 'text-right input-available',
				render: function(data, type, row, meta) {
					return data.toString().toFormat('NUMBER');
				}
			},
			{ data: '3m', className: 'text-right input-available',
				render: function(data, type, row, meta) {
					return data.toString().toFormat('NUMBER');
				}
			},
			{ data: '4m', className: 'text-right input-available',
				render: function(data, type, row, meta) {
					return data.toString().toFormat('NUMBER');
				}
			},
			{ data: '5m', className: 'text-right input-available',
				render: function(data, type, row, meta) {
					return data.toString().toFormat('NUMBER');
				}
			},
			{ data: '6m', className: 'text-right input-available',
				render: function(data, type, row, meta) {
					return data.toString().toFormat('NUMBER');
				}
			},
			{ data: '7m', className: 'text-right input-available',
				render: function(data, type, row, meta) {
					return data.toString().toFormat('NUMBER');
				}
			},
			{ data: '8m', className: 'text-right input-available',
				render: function(data, type, row, meta) {
					return data.toString().toFormat('NUMBER');
				}
			},
			{ data: '9m', className: 'text-right input-available',
				render: function(data, type, row, meta) {
					return data.toString().toFormat('NUMBER');
				}
			},
			{ data: '10m', className: 'text-right input-available',
				render: function(data, type, row, meta) {
					return data.toString().toFormat('NUMBER');
				}
			},
			{ data: '11m', className: 'text-right input-available',
				render: function(data, type, row, meta) {
					return data.toString().toFormat('NUMBER');
				}
			},
            { data: '12m', className: 'text-right input-available',
				render: function(data, type, row, meta) {
					return data.toString().toFormat('NUMBER');
				}
			},
            { data: 'tot', className: 'text-right tot text-number',
				render: function(data, type, row, meta) {
					return data.toString().toFormat('NUMBER');
				}
			}
		],
		footerCallback: function ( row, data, start, end, display ) {
			var api = this.api(), data;
			var intVal = function ( i ) {
                return typeof i === 'string' ? i.replace(/[\$,]/g, '')*1 : typeof i === 'number' ? i : 0;
			};

			for (i=4; i<17; i++) {
				pageTotal = api.column( i, { page: 'current'} ).data().reduce( function (a, b) {
                    return intVal(a) + intVal(b);
				}, 0 );
				$('#dtList1').find('tfoot th:eq('+(i-3)+')').html(pageTotal.toString().toFormat('NUMBER'));
			}
		},
		initComplete: function(settings, json) { //console.log('initComplete', json);

			var myList = this;

			$(myList).on('click', 'tbody tr td.input-available', function(pEvent) {
				if ($(this).parent().find('td.dataTables_empty').length > 0) {
					return;
				} else {
					if($(this).hasClass("selected")){
						$(this).removeClass("selected");
					}
					else{
						$(document).find('td.selected').removeClass('selected');
						$(this).addClass('selected');
					}
				}
			});

			$(myList).on('click', '#btnSearch', function(pEvent) {
				$.datatable1.ajax.reload();
			});

			$(myList).on('click', '#btnSearch', function(pEvent) {
				$.datatable1.ajax.reload();
			});


			$(myList).on('keyup', 'thead input', function(pEvent){
				if(pEvent.keyCode === 13)
					$.datatable1.ajax.reload();
				// if (pEvent.keyCode === 13) {
				// }
			});

			$(myList).on('change', 'thead select', function(pEvent){
				$.datatable1.ajax.reload();
			});

			$('#btnExcel').on('click', function(pEvent) {
				$('.dt-button.buttons-excel.buttons-html5').trigger('click');
			});

            $('[data-toggle="tab"]').on('click', function(pEvent){
               var s_amt_ty_code = $(this).parent().data('action');
                $("#s_amt_ty_code").val(s_amt_ty_code);
				$.datatable1.ajax.reload();
            });

		},
    });



	/*
	var s_year = $("#s_year").val();
	var s_dept_code = $("#s_dept_code").val();
	var s_mber_sn = $("#s_mber_sn").val();
	var s_spt_nm = $("#s_spt_nm").val();
	var s_amt_ty_code = $("#s_amt_ty_code").val();
	try{
		if(/^\d+$/.test(s_year)){
			s_year = parseInt(s_year);
		}
		else{
			throw new Error(`Parameter is not a number : ${s_year}`);
		}
	}catch(e){
		alert("올바른 년도 형식이 아닙니다. 네자리 숫자 형식으로 입력해주세요.");
		$("#s_year").val("");
		return false;
	}
	var params = '';
	params += '&s_year='+s_year;
	params += '&s_amt_ty_code='+s_amt_ty_code;
	if(s_dept_code != "")
		params += '&s_dept_code='+s_dept_code;
	if(s_mber_sn != "")
		params += '&s_mber_sn='+s_mber_sn;
	if(s_spt_nm != "")
		params += '&s_spt_nm='+s_spt_nm;
	$.ajax({
		url: '/api/goal/ajax_get_goals',
		type: 'GET',
		data: params,
		dataType: 'json',
		contentType: false,
		processData: false,
		success: function(pResult) {
			console.log(pResult);
		}
	});
	*/

}

</script>

<script>
$(document).on("dblclick", ".input-available", function(){

	var authors = ["*"];
	var loginId = $("#loginID").val();
	if(!authors.includes("*") && !authors.includes(loginId)){
		alert("권한이 없습니다.");
		return false;
	}

	var data = prompt("값을 입력하세요.");
	try{
		if(/^\d+$/.test(data)){
			data = parseInt(data);
		}
		else{
			throw new Error(`Parameter is not a number : ${data}`);
		}
	}catch(e){
		alert("숫자 형식이 아닙니다. 올바른 형식으로 입력해주세요.");
		return false;
	}
	var td = $(this);
	var s_amt_ty_code = $(this).parent().data("amt");
	var s_mber_sn = $(this).parent().data("mber");
	var s_cntrct_sn = $(this).parent().data("cntrct");
	var s_year = $(this).parent().data("year");
	var column = $(this).data("col");
	var params = '';
	params += '&s_amt_ty_code='+s_amt_ty_code;
	params += '&s_mber_sn='+s_mber_sn;
	params += '&s_cntrct_sn='+s_cntrct_sn;
	params += '&s_year='+s_year;
	params += '&column='+column;
	params += '&data='+data;
	$.ajax({
		url: '/api/goal/set_goal',
		type: 'GET',
		data: params,
		dataType: 'json',
		contentType: false,
		processData: false,
		success: function (pResult) {
			if(pResult.status){
				$(td).text(data.toString().toFormat("NUMBER"));
				var total = 0;
				$(td).parent().find("td.input-available").each(function(pIndex, pTag){
					let amount = parseInt($(pTag).text().replaceAll(",", ""));
					if(isNaN(amount)) amount = 0;
					total += amount;
				});
				$(td).parent().find("td.tot").text(total.toString().toFormat("NUMBER"));
			}
		}
	});

});

$(document).on('click', '#btnExcel', function(e) {
    var postfix = $("#s_year").val();
    var fileName = "월별 매출현황(공조)"+postfix+".xls";
    var a = document.createElement('a');
    var data_type = 'data:application/vnd.ms-excel';
    var table_html = '';
    var tbl = 'dtList1';
    var table_div = document.getElementById(tbl);

    table_html += table_div.outerHTML.replace(/ /g, '%20');
    a.href = data_type + ',%EF%BB%BF' + table_html;
    a.download = fileName;
    a.click();


    e.preventDefault();



});

</script>
<script type="text/javascript">


$(function () {
  $('table.floating-thead').each(function() {
    if( $(this).css('border-collapse') == 'collapse') {
      $(this).css('border-collapse','separate').css('border-spacing',0);
    }
    $(this).prepend( $(this).find('thead:first').clone().hide().css('top',160).css('position','fixed') );
  });

  $(window).scroll(function() {
    var scrollTop = $(window).scrollTop(),
      scrollLeft = $(window).scrollLeft();
    $('table.floating-thead').each(function(i,v) {
      var thead = $(this).find('thead:last'),
        clone = $(this).find('thead:first'),
        top = $(this).offset().top,
        bottom = top + $(this).height() - thead.height();

      if( scrollTop < top-180 || scrollTop > bottom ) {
        clone.hide();
        return true;
      }
      if( clone.is('visible') ) return true;
      var fixP = 0;
      clone.find('th').each(function(i) {
        if(thead.find('th').eq(i).html() == '계'){
            fixP = -1;
        }
        $(this).width( thead.find('th').eq(i).width() +fixP);
      });
      clone.css("margin-left", -scrollLeft ).width( thead.width() ).show();
    });
  });
});

$(function() {
	/**************************************************************************
     *
     */
    var year = new Date().getFullYear();
    $("#s_year").val(year);

	$('[data-toggle="tab"]').on('click', function(pEvent){
	   var s_amt_ty_code = $(this).parent().data('action');
		$("#s_amt_ty_code").val(s_amt_ty_code);
	});

	$('[data-toggle="tab"]').eq(0).trigger('click');
	getGoals();
});
</script>
{% endblock %}
