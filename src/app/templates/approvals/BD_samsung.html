{% include "approvals/common_style.html" %}
<style>
    .input-available{
        height:36px!important;
    }
    table.table-bordered td:last-child, table.table-bordered th:last-child {
        border-right-width: 1px!important;
    }
    .jarviswidget td:last-child, .jarviswidget th:last-child {
        border-right:1px solid #ddd;
    }
</style>
<table class="table table-bordered table-form sub-table" style="width:35%!important;">
    <colgroup>
        <col width="25%">
        <col width="25%">
        <col width="25%">
        <col width="25%">
    </colgroup>
    <thead>
        <tr>
            <th colspan="4" class="sub-title colorN text-center"><span>현 장 현 황</span></th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td class="colorSky text-center">계약번호</td>
            <td class="hasinput" colspan="3"><input type="text" class="form-control text-center" name="cntrct_no" id="cntrct_no" readonly></td>
        </tr>
        <tr>
            <td class="colorSky text-center">현장명</td>
            <td class="text-center hasinput" colspan="3">
                <select class="form-control select2 w100p" id="cntrct_sn" name="cntrct_sn" style="padding-top:0px!important;padding-bottom:0px!important;">
                    {% if not init %}
                        <option value=""></option>
                        {% for code in contract_list %}
                        <option value="{{code.value}}">{{code.label}}</option>
                        {% endfor %}
                    {% endif %}
                </select>

            </td>
        </tr>
        <tr>
            <td class="colorSky text-center">세대수</td>
            <td class="hasinput"><input type="text" class="form-control text-center" name="home_count" id="home_count" readonly></td>
            <td class="colorSky text-center">지역</td>
            <td class="hasinput"><input type="text" class="form-control text-center" name="home_region" id="home_region" readonly></td>
        </tr>
        <tr>
            <td class="colorSky text-center">공사기간</td>
            <td class="hasinput" colspan="3"><input type="text" class="form-control text-center" name="cntrwk_period" id="cntrwk_period" readonly></td>
        </tr>
    </tbody>
    <tbody role="equip">
        <tr>
            <td class="colorSky text-center">납품일정</td>
            <td class="hasinput" colspan="3">
                <input type="text" class="form-control text-left" name="pay_period" id="pay_period"/>
            </td>
        </tr>
        <tr>
            <td class="colorSky text-center">결제방법</td>
            <td class="hasinput" colspan="3">
                <input type="text" class="form-control text-left" name="pay_method" id="pay_method"/>
            </td>
        </tr>
  </tbody>
</table>
<table class="table table-bordered table-form main-table">
    <colgroup>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
    </colgroup>
    <thead>
        <tr>
			<th class="sub-title colorN text-center" colspan="14"><span style="position:absolute;left:50%;top:50%;transform:translate(-50%, -50%);">① 장비 매입/출고 현황 - VAT포함</span>
            </th>

        </tr>
    </thead>
    <tbody role="header">
        <tr>
            <th class="color-contract text-center">상품명</th>
            <th class="color-contract text-center">모델명</th>
            <th class="color-contract text-center">계약수량</th>
            <th class="color-contract text-center">출고가</th>
            <th class="color-contract text-center">매입DC율(%)</th>
            <th class="color-contract text-center">매입단가</th>
            <th class="color-contract text-center">장비매입금액</th>
            <th class="color-contract text-center">매입처</th>
            <th class="color-contract text-center">출고일</th>
            <th class="color-contract text-center">기출고수량</th>
            <th class="color-contract text-center">출고수량</th>
            <th class="color-contract text-center">계약단가</th>
            <th class="color-contract text-center">계약총액</th>
            <th class="color-contract text-center">이익금(VA)</th>
        </tr>
    </tbody>
    <tbody role="equip_row">
        <tr data-row="equip_tr">
            <td class="hasinput">
                <select class="form-control select2" name="prdlst_se_code[]" style="width:100%!important;">
                    <option value="">[전체]</option>
                    {% for code in prdlst_se_code_list %}
                    <option value="{{code.value}}">{{code.label}}</option>
                    {% endfor %}
                </select>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-left" name="model_no[]"/>
                <input type="hidden" class="form-control text-left" name="equip_sn[]"/>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-right" data-type="number" name="cnt_dlnt[]"/>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-right" data-type="number" name="dlivy_amt[]"/>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-right" data-type="rate" name="rate[]"/>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-right" data-type="number" name="pamount[]"/>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-right" data-type="number" name="samsung_amount[]"/>
            </td>
            <td class="hasinput">
                <select class="form-control select2" name="bcnc_sn[]" style="width:100%!important;">
                    <option value=""></option>
                    {% for code in bcnc_list %}
                    <option value="{{code.value}}">{{code.value}}.{{code.label}}</option>
                    {% endfor %}
                </select>
            </td>

            <td class="hasinput">
                <input type="text" class="form-control text-center" data-type="date" name="dlivy_de[]" readonly/>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-right" data-type="number" name="sdlnt[]" readonly/>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-right" data-type="number" name="dlnt[]"/>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-right" data-type="number" name="cntrct_amount[]"/>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-right" data-type="number" name="amount[]"/>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-right" data-type="number" name="va[]"/>
            </td>
        </tr>
    </tbody>
    <tfoot>
        <tr>
            <td class="colorG text-center" colspan="2">합계</td>
            <td class="colorG text-right" data-column="total_cnt_dlnt"></td>
            <td class="colorG"></td>
            <td class="colorG"></td>
            <td class="colorG text-right" data-column="total_pamount"></td>
            <td class="colorP text-right" data-column="total_samsung_amount"></td>
            <td class="colorG"></td>
            <td class="colorG"></td>
            <td class="colorG text-right" data-column="total_sdlnt"></td>
            <td class="colorG text-right" data-column="total_dlnt"></td>
            <td class="colorG"></td>
            <td class="colorG text-right" data-column="total_amount"></td>
            <td class="colorG text-right" data-column="total_va"></td>
        </tr>
    </tfoot>
</table>
<style>
    .table td.hasinput{
        padding:2px!important;
    }
    .hasinput .table td.hasinput{
        padding:2px!important;
    }
</style>
<table class="table table-bordered table-form small-table" style="width:35%!important;">
    <colgroup>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
    </colgroup>
    <thead>
        <tr>
            <th class="sub-title colorN text-center" colspan="4"><span>특이사항</span></th>
        </tr>

    </thead>
  <tbody>
    <tr>
        <td class="text-center" colspan="4"><textarea style="width:100%;height:100%;resize:none;border:none;" name="option_bigo"></textarea></td>
    </tr>
  </tbody>
</table>

<script>
    function dateDiff(_date1, _date2) {
        console.log(_date1, _date2);
        var diffDate_1 = new Date(_date1);
        var diffDate_2 = new Date(_date2);

        var diff = Math.abs(diffDate_2.getTime() - diffDate_1.getTime());
        console.log(diff);
        diff = Math.round(diff / (1000 * 3600 * 24));
        console.log(diff);

        return diff;
    }

    function isValidDate(dateString) {
      var regEx = /^\d{4}-\d{2}-\d{2}$/;
      if(!dateString.match(regEx)) return false;  // Invalid format
      var d = new Date(dateString);

      var dNum = d.getTime();
      if(!dNum && dNum !== 0) return false; // NaN value, Invalid date
      return (new Date(d.getTime()-(new Date()).getTimezoneOffset())).toISOString().slice(0,10) === dateString;
    }
    get_cost_bf_bd = function(cntrct_sn){
        $.ajax({
            url : '/api/project/get_cost_bf_bd',
            method: 'GET',
            data : {"s_cntrct_sn" : cntrct_sn},
            success: function(pResult){
                console.log(pResult);
                var cntrct_amount_total = 0, amount_total = 0;
                cloneRow("construct_tr", pResult.cCostList.length-1);
                $.each(pResult.cCostList, function(pIndex, pValue){
                    $("tbody[role='construct_row']").find(`[name="model_no[]"]`).eq(pIndex).val(pValue.model_no);
                    $("tbody[role='construct_row']").find(`[name="qy[]"]`).eq(pIndex).val(pValue.qy.toFormat('NUMBER'));
                    $("tbody[role='construct_row']").find(`[name="dlivy_amt[]"]`).eq(pIndex).val(pValue.puchas_amount.toFormat('NUMBER'));
                    $("tbody[role='construct_row']").find(`[name="dlamt[]"]`).eq(pIndex).val(Math.round((100.0-pValue.dscnt_rt)*pValue.puchas_amount/100.0).toFormat('NUMBER'));
                    $("tbody[role='construct_row']").find(`[name="cntrct_dlamt[]"]`).eq(pIndex).val(pValue.salamt.toFormat('NUMBER'));
                });
                $("tbody[role='construct_row']").trigger("change");
                cloneRow("construct_expect_tr", pResult.cCostListExtra.length-1);
                $.each(pResult.cCostListExtra, function(pIndex, pValue){
                    var amount = Math.round(pValue.puchas_amount * (100 - pValue.dscnt_rt) / 100.0 * pValue.qy);
                    var cntrct_amount = pValue.salamt * pValue.qy;
                    cntrct_amount_total += cntrct_amount;
                    amount_total += amount;
                    $("tbody[role='construct_expect_row']").find(`[name="expect_model_no[]"]`).eq(pIndex).val(pValue.model_no);
                    $("tbody[role='construct_expect_row']").find(`[name="expect_qy[]"]`).eq(pIndex).val(pValue.qy.toFormat('NUMBER'));
                    $("tbody[role='construct_expect_row']").find(`[name="expect_dlivy_amt[]"]`).eq(pIndex).val(pValue.puchas_amount.toFormat('NUMBER'));
                    $("tbody[role='construct_expect_row']").find(`[name="expect_dlamt[]"]`).eq(pIndex).val(Math.round((100.0-pValue.dscnt_rt)*pValue.puchas_amount/100.0).toFormat('NUMBER'));
                    $("tbody[role='construct_expect_row']").find(`[name="expect_cntrct_dlamt[]"]`).eq(pIndex).val(pValue.salamt.toFormat('NUMBER'));
                });
                $("tbody[role='construct_expect_row']").trigger("change");
                $.each(pResult.eCostListExtra, function(pIndex, pValue){
                    if(pValue.ct_se_code == "61"){

                        $(`tbody[role="ct_se_code"]`).find(`[name="D_61"]`).val(pValue.puchas_amount.toFormat('NUMBER'));
                        $(`tbody[role="ct_se_code"]`).find(`[name="D_61_DC"]`).val((pValue.puchas_amount*pValue.add_dscnt_rt/100.0).toFormat('NUMBER'));
                    }
                    else if(pValue.ct_se_code == "7"){
                        $(`tbody[role="ct_se_code"]`).find(`[name="D_7"]`).val(pValue.puchas_amount.toFormat('NUMBER'));
                        $(`tbody[role="ct_se_code"]`).find(`[name="E_7"]`).val(pValue.puchas_amount.toFormat('NUMBER'));
                    }
                    else if(pValue.ct_se_code == "10"){
                        $(`tbody[role="ct_se_code"]`).find(`[name="D_10"]`).val(pValue.puchas_amount.toFormat('NUMBER'));
                    }
                });
                var e_61 = 0;
                var e_61_dc = 0;
                $.each(pResult.eCostList, function(pIndex, pValue){
                    if(["61", "62", "64", "65"].includes(pValue.ct_se_code)){
                        e_61 += pValue.puchas_amount;
                        e_61_dc += (pValue.puchas_amount*pValue.add_dscnt_rt/100.0);
                    }
                });
                $(`tbody[role="ct_se_code"]`).find(`[name="E_61"]`).val(e_61.toFormat('NUMBER'));
                $(`tbody[role="ct_se_code"]`).find(`[name="E_61_DC"]`).val(e_61_dc.toFormat('NUMBER'));
                $.each(pResult.gCostList, function(pIndex, pValue){
                     $(`tbody[role="ct_se_code"]`).find(`[name="D_63"]`).val(pValue.salamt.toFormat('NUMBER'));
                     $(`tbody[role="ct_se_code"]`).find(`[name="E_63"]`).val(pValue.salamt.toFormat('NUMBER'));
                });
                $(`tbody[role="ct_se_code"]`).find(`[name="total_cntrct_amount"]`).val(cntrct_amount_total.toFormat('NUMBER'));
                $(`tbody[role="ct_se_code"]`).find(`[name="total_amount"]`).val(amount_total.toFormat('NUMBER'));

                $(`tbody[role="ct_se_code"]`).trigger("change");

                $(document).find("tbody[role='ct_se_code'] input").attr("disabled", false);
                $(document).find("tbody[role='ct_se_code'] input").attr("readonly", true);
                $(document).find("tbody[role='equip_row'] input, tbody[role='equip_row'] select").attr("disabled", false);

                {% if init %}
                cloneRow("equip_tr", pResult.samsungList.length-1);
                {% endif %}

                $.each(pResult.samsungList, function(pIndex, pRow){
                    /*
                    *   bcnc_sn :74
                        cnt_dlnt:100
                        delng_ty_code:1
                        dlamt:204600
                        dlivy_de:""
                        equip_sn:46
                        model_no:"RB33R8798SR2"
                        prdlst_se_code:9
                        rm:""
                        samount:264000
                        sdlnt:0
                    * */
                    var tr = $(document).find("tr[data-row='equip_tr']").eq(pIndex);
                    $(tr).find(`[name="equip_sn[]"]`).val(pRow.equip_sn);
                    $(tr).find(`[name="prdlst_se_code[]"]`).yVal(pRow.prdlst_se_code);
                    $(tr).find(`[name="bcnc_sn[]"]`).yVal(pRow.bcnc_sn);
                    $(tr).find(`select`).find("option:not(:selected)").attr("disabled", "disabled");
                    $(tr).find(`[name="model_no[]"]`).val(pRow.model_no);
                    $(tr).find(`[name="model_no[]"]`).attr("readonly", true);
                    $(tr).find(`[name="cnt_dlnt[]"]`).val(pRow.cnt_dlnt.toFormat('NUMBER'));
                    $(tr).find(`[name="cnt_dlnt[]"]`).attr("readonly", true);
                    $(tr).find(`[name="dlivy_amt[]"]`).val(pRow.dlivy_amt.toFormat('NUMBER'));
                    $(tr).find(`[name="dlivy_amt[]"]`).attr("readonly", true);
                    $(tr).find(`[name="rate[]"]`).val((100.0-(pRow.dlamt*100.0/pRow.dlivy_amt)).toFixed(2)+"%");
                    $(tr).find(`[name="rate[]"]`).attr("readonly", true);
                    $(tr).find(`[name="pamount[]"]`).val(pRow.dlamt.toFormat('NUMBER'));
                    $(tr).find(`[name="pamount[]"]`).attr("readonly", true);
                    $(tr).find(`[name="samsung_amount[]"]`).val((pRow.dlamt*pRow.cnt_dlnt).toFormat('NUMBER'));
                    $(tr).find(`[name="samsung_amount[]"]`).attr("readonly", true);
                    $(tr).find(`[name="sdlnt[]"]`).val(pRow.sdlnt.toFormat('NUMBER'));
                    $(tr).find(`[name="sdlnt[]"]`).attr("readonly", true);
                    $(tr).find(`[name="cntrct_amount[]"]`).val(pRow.samount.toFormat('NUMBER'));
                    $(tr).find(`[name="cntrct_amount[]"]`).attr("readonly", true);
                    $(tr).find(`[name="amount[]"]`).val((pRow.samount*pRow.cnt_dlnt).toFormat('NUMBER'));
                    $(tr).find(`[name="amount[]"]`).attr("readonly", true);
                    $(tr).find(`[name="dlivy_de[]"]`).val(pRow.dlivy_de);
                    $(tr).find(`[name="dlivy_de[]"]`).attr("readonly", true);
                    $(tr).find(`[name="va[]"]`).attr("readonly", true);


                });
                $("tbody[role='equip_row']").trigger("change");


            }

        })
    }
    fnValidate = function(){
                    var result = true;
                    return result;
               }
    cloneRow = function(selector, count){
        if(selector == "equip_tr"){
            for(let i=0;i<count;i++) {
                var trs = $(document).find("tbody[role='equip_row'] tr");
                var origin = trs.eq(0).clone(true);
                $(origin).find("td:not(.hasinput)").html("");
                $(origin).find("td.hasinput input").val("");
                $(origin).find("td.hasinput select").each(function (pIndex, pTag) {

                    if (pIndex == 0) {
                        $(pTag).parent().html(`<select class="form-control select2 cloned" name="prdlst_se_code[]" style="width:100%!important;">
                                                    <option value="">[전체]</option>
                                                    {% for code in prdlst_se_code_list %}
                                                    <option value="{{code.value}}">{{code.label}}</option>
                                                    {% endfor %}
                                                </select>`);
                    } else if (pIndex == 1) {
                        $(pTag).parent().html(`<select class="form-control select2 cloned" name="bcnc_sn[]" style="width:100%!important;">
                                                <option value="">[전체]</option>
                                                {% for code in bcnc_list %}
                                                <option value="{{code.value}}">{{code.value}}.{{code.label}}</option>
                                                {% endfor %}
                                            </select>`);
                    }
                });
                $(document).find("tbody[role='equip_row']").append($(origin));
            }
            {% if init %}
                $(document).find(".cloned").select2();
                $(document).find(".cloned").removeClass("cloned");
            {% endif %}
            $(document).find("tbody[role='equip_row']").trigger("change");
        }
    }
    $(document).on("change", "tbody[role='equip_row']", function(){

        var total_cnt_dlnt = 0;
        var total_pamount = 0;
        var total_samsung_amount = 0;
        var total_sdlnt = 0;
        var total_dlnt = 0;
        var total_amount = 0;
        var total_va = 0;
        $(this).find("tr").each(function(pIndex, pRow){
            var cnt_dlnt = parseInt($(pRow).find("[name='cnt_dlnt[]']").val().replaceAll(",", "")); if(isNaN(cnt_dlnt)) cnt_dlnt = 0;
            var pamount = parseInt($(pRow).find("[name='pamount[]']").val().replaceAll(",", "")); if(isNaN(pamount)) pamount = 0;
            var samsung_amount = parseInt($(pRow).find("[name='samsung_amount[]']").val().replaceAll(",", "")); if(isNaN(samsung_amount)) samsung_amount = 0;
            var sdlnt = parseInt($(pRow).find("[name='sdlnt[]']").val().replaceAll(",", "")); if(isNaN(sdlnt)) sdlnt = 0;
            var dlnt = parseInt($(pRow).find("[name='dlnt[]']").val().replaceAll(",", "")); if(isNaN(dlnt)) dlnt = 0;
            if(dlnt>(cnt_dlnt-sdlnt)){
                dlnt = cnt_dlnt - sdlnt;
                $(pRow).find("[name='dlnt[]']").val(dlnt.toFormat('NUMBER'));
            }
            var cntrct_amount = parseInt($(pRow).find("[name='cntrct_amount[]']").val().replaceAll(",", "")); if(isNaN(cntrct_amount)) cntrct_amount = 0;
            var amount = cnt_dlnt*cntrct_amount;
            var va = amount-samsung_amount;
            total_cnt_dlnt += cnt_dlnt;
            total_pamount += pamount;
            total_samsung_amount += samsung_amount;
            total_sdlnt += sdlnt;
            total_dlnt += dlnt;
            total_amount += amount;
            total_va += va;
            $(pRow).find("[name='va[]']").val(va.toFormat('NUMBER'));
            $(pRow).find("[name='amount[]']").val(amount.toFormat('NUMBER'));
        });
        $(this).parent().find("[data-column='total_cnt_dlnt']").html(total_cnt_dlnt.toFormat('NUMBER'));
        $(this).parent().find("[data-column='total_pamount']").html(total_pamount.toFormat('NUMBER'));
        $(this).parent().find("[data-column='total_samsung_amount']").html(total_samsung_amount.toFormat('NUMBER'));
        $(this).parent().find("[data-column='total_sdlnt']").html(total_sdlnt.toFormat('NUMBER'));
        $(this).parent().find("[data-column='total_dlnt']").html(total_dlnt.toFormat('NUMBER'));
        $(this).parent().find("[data-column='total_amount']").html(total_amount.toFormat('NUMBER'));
        $(this).parent().find("[data-column='total_va']").html(total_va.toFormat('NUMBER'));

    });

    $(document).on("change", "tbody[role='ct_se_code']", function(){
        var total_cntrct_amount = parseInt($(document).find("[name='total_cntrct_amount']").val().replaceAll(",", "")); if(isNaN(total_cntrct_amount)) total_cntrct_amount = 0;
        var total_amount = parseInt($(document).find("[name='total_amount']").val().replaceAll(",", "")); if(isNaN(total_amount)) total_amount = 0;
        var D_61_DC = parseInt($(document).find("[name='D_61_DC']").val().replaceAll(",", "")); if(isNaN(D_61_DC)) D_61_DC = 0;
        var D_63 = parseInt($(document).find("[name='D_63']").val().replaceAll(",", "")); if(isNaN(D_63)) D_63 = 0;
        var D_61 = parseInt($(document).find("[name='D_61']").val().replaceAll(",", "")); if(isNaN(D_61)) D_61 = 0;
        var D_7 = parseInt($(document).find("[name='D_7']").val().replaceAll(",", "")); if(isNaN(D_7)) D_7 = 0;
        var D_10 = parseInt($(document).find("[name='D_10']").val().replaceAll(",", "")); if(isNaN(D_10)) D_10 = 0;

        var va = total_cntrct_amount + D_61_DC + D_63 - D_61 - D_7 - D_10 - total_amount;


        $(this).find("[data-column='va']").html(va.toFormat('NUMBER'));
        $(this).find("[data-column='va_rate']").html((va*100.0/total_cntrct_amount).toFixed(1)+"%");

        var E_total_cntrct_amount = parseInt($(document).find("[name='E_total_cntrct_amount']").val().replaceAll(",", "")); if(isNaN(E_total_cntrct_amount)) E_total_cntrct_amount = 0;
        var E_total_amount = parseInt($(document).find("[name='E_total_amount']").val().replaceAll(",", "")); if(isNaN(E_total_amount)) E_total_amount = 0;
        var E_61_DC = parseInt($(document).find("[name='E_61_DC']").val().replaceAll(",", "")); if(isNaN(E_61_DC)) E_61_DC = 0;
        var E_63 = parseInt($(document).find("[name='E_63']").val().replaceAll(",", "")); if(isNaN(E_63)) E_63 = 0;
        var E_61 = parseInt($(document).find("[name='E_61']").val().replaceAll(",", "")); if(isNaN(E_61)) E_61 = 0;
        var E_7 = parseInt($(document).find("[name='E_7']").val().replaceAll(",", "")); if(isNaN(E_7)) E_7 = 0;
        var E_10 = parseInt($(document).find("[name='E_10']").val().replaceAll(",", "")); if(isNaN(E_10)) E_10 = 0;

        var E_va = E_total_cntrct_amount + D_61_DC + D_63 - D_61 - D_7 - D_10 - E_total_amount;


        $(this).find("[data-column='E_va']").html(E_va.toFormat('NUMBER'));
        $(this).find("[data-column='E_va_rate']").html((E_va*100.0/E_total_cntrct_amount).toFixed(1)+"%");
    });


    {% if init %}
    window.projects = {};
    $(document).ready(function(){
        $(document).find("tbody[role='ct_se_code'] input").attr("disabled", true);
        $(document).find("tbody[role='equip_row'] input").attr("disabled", true);
        $(document).find("tbody[role='equip_row'] select").attr("disabled", true);
        $.ajax({
            url : '/api/project/get_p_projects',
            method: 'GET',
            success: function(pResult){
                var html = `<option value="">[전체]</option>`;
                $.each(pResult, function(pIndex, pValue){
                    html += `<option value="${pValue.cntrct_sn}">${pValue.spt_nm}</option>`;
                    window.projects[pValue.cntrct_sn] = pValue;
                });
                $(document).find("#cntrct_sn").html(html);


            }
        });
        var input = document.querySelector('input[data-type="number"]');
        input.addEventListener('input', function() {
          this.value = this.value.replace(/[^0-9 \,]/, '');
        });
    });
    $(document).on("focusout", "input[data-type='number']", function(){
        var value = $(this).val().replaceAll(",", "").toFormat('NUMBER');
        $(this).val(value);
    });
    $(document).on("focusout", "input", function(){
        $(this).closest("tbody").trigger("change");
    });
    $(document).on("focusout", "input[data-type='date']", function(){
        if(!isValidDate($(this).val()) && $(this).val() != ''){
            alert("날짜 형식이 올바르지 않습니다. (yyyy-mm-dd)");
            $(this).val("");
        }
    });

    $(document).on("keyup", "input", function(e){
        if(e.keyCode == 13){
            $(this).focusout();
        }
    });
    $(document).on('select2:open', '.select2', function (e) {
        const evt = "scroll.select2";
        $(e.target).parents().off(evt);
        $(window).off(evt);
    });
    $(document).on("change", "#cntrct_sn", function(){
        var cntrct_sn = $("#cntrct_sn").find(":selected").val();
        if(cntrct_sn != ''){
            var pValue = window.projects[cntrct_sn];
            $("#cntrct_no").val(pValue.cntrct_no);
            $("#home_count").val(pValue.home_count);
            $("#home_region").val(pValue.home_region);
            $("#cntrwk_period").val(pValue.cntrwk_period);
            get_cost_bf_bd(cntrct_sn);
        }
    });
    {% else %}
    $.fn.afterLoadApproval = function() {

    }
    {% endif %}
</script>