
<style>
    .input-available{
        height:36px!important;
    }
</style>
<table class="table table-bordered table-form" style="width:35%!important;">
    <colgroup>
        <col width="25%">
        <col width="75%">
    </colgroup>
    <tbody>
        <tr>
            <th colspan="2" style="background:#0070C0;border-color:#0070C0;color:white;">현장현황</th>
        </tr>
        <tr>
            <td class="colorSky">계약번호</td>
            <td class="hasinput"><input type="text" class="form-control text-center" name="cntrct_no" id="cntrct_no" readonly></td>
        </tr>
        <tr>
            <td class="colorSky">현장명</td>
            <td class="text-center hasinput">
                <select class="form-control select2 w100p" id="cntrct_sn" name="cntrct_sn" style="padding-top:0px!important;padding-bottom:0px!important;">
                    {% if not init %}
                        <option value=""></option>
                        {% for code in contract_list %}
                        <option value="{{code.value}}">{{code.label}}</option>
                        {% endfor %}
                    {% endif %}
                </select>

            </td>
        </tr>
        <tr>
            <td class="colorSky">세대수</td>
            <td class="hasinput"><input type="text" class="form-control text-center" name="home_count" id="home_count" readonly></td>
        </tr>
        <tr>
            <td class="colorSky">지역</td>
            <td class="hasinput"><input type="text" class="form-control text-center" name="home_region" id="home_region" readonly></td>
        </tr>
        <tr>
            <td class="colorSky">공사기간</td>
            <td class="hasinput"><input type="text" class="form-control text-center" name="cntrwk_period" id="cntrwk_period" readonly></td>
        </tr>

    </tbody>
</table>
<table class="table table-bordered table-form">
    <colgroup>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
    </colgroup>
    <thead>
        <tr>
			<th class="sub-title colorN text-center" colspan="6" style="border-right:0px!important;">공사비 산출 (영업/자동)</th>
			<th class="sub-title colorN text-right" style="border-left:0px!important;">
                <div class="btn-group">
                    <button type="button" class="btn btn-table btn-warning" title="추가" id="addRow"><i class="fa fa-plus"></i></button>
                </div>
            </th>

        </tr>
        <tr>
            <th class="color-contract text-center">내역</th>
            <th class="color-contract text-center">실내기대수</th>
            <th class="color-contract text-center">대당단가</th>
            <th class="color-contract text-center">공급가액</th>
            <th class="color-contract text-center">세액</th>
            <th class="color-contract text-center">합계</th>
            <th class="color-contract text-center">내역</th>
        </tr>
    </thead>
    <tbody role="row">
        <tr data-row="1">
            <td class="text-center input-available" data-type="string" data-column="memo1"></td>
            <td class="text-center input-available" data-type="number" data-column="memo2" onchange="multiply(this, ['memo2', 'memo3'], 'memo23', true)"></td>
            <td class="text-right input-available" data-type="number" data-column="memo3" onchange="multiply(this, ['memo2', 'memo3'], 'memo23', true)"></td>
            <td class="text-right" data-column="memo23" onchange="sum(this, ['memo23', 'memo4'], 'memo234', true)">0</td>
            <td class="text-right input-available" data-type="number" data-column="memo4" onchange="sum(this, ['memo23', 'memo4'], 'memo234', true)"></td>
            <td class="text-right" data-column="memo234" onchange="sum(this, ['memo234'], '#total')">0</td>
            <td class="text-right colorP no-clone" id="total">0</td>
        </tr>
    </tbody>
</table>
<table class="table table-bordered table-form">
    <colgroup>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
    </colgroup>
    <thead>
        <tr>
			<th class="sub-title colorN text-center" colspan="15">공사 현황 (영업) - VAT포함</th>
        </tr>
        <tr>
            <th class="colorB text-center">구분</th>
            <th class="color-contract text-center">내역</th>
            <th class="color-contract text-center">삼성장비</th>
            <th class="color-contract text-center">타사장비</th>
            <th class="color-contract text-center">설치비</th>
            <th class="color-contract text-center">간접비</th>
            <th class="color-contract text-center">로지텍자재</th>
            <th class="color-contract text-center">타사자재</th>
            <th class="color-contract text-center">기타(총액 0.5%)</th>
            <th class="color-contract text-center">M,S/H(기준표)</th>
            <th class="color-contract text-center">옵션행사비(기준표)</th>
            <th class="color-contract text-center">설계변경</th>
            <th class="color-contract text-center">총액</th>
            <th class="color-contract text-center">이익금(VA)</th>
            <th class="color-contract text-center">VA율</th>
        </tr>
    </thead>
    <tbody>
        <tr data-row="B">
            <th class="colorB text-center middle" rowspan="2">사전입찰</th>
            <th class="colorSky text-center">예정가</th>
            <td class="text-center input-available" data-type="number" data-column="1" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center input-available" data-type="number" data-column="2" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center input-available" data-type="number" data-column="5" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center input-available" data-type="number" data-column="8" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center input-available" data-type="number" data-column="3" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center input-available" data-type="number" data-column="4" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center input-available" data-type="number" data-column="10" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center input-available" data-type="number" data-column="61" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center input-available" data-type="number" data-column="7" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center input-available" data-type="number" data-column="99" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center" data-column="row_total" onchange="sub(this, ['row_total'], '#va')"></td>
            <td class="text-center" id="va" rowspan="2" onchange="rate(this, ['#va', 'row_total'], '#va_rate', true)"></td>
            <td class="text-center" id="va_rate" rowspan="2"></td>
        </tr>
        <tr data-row="D">
            <th class="colorSky text-center">실행가</th>
            <td class="text-center input-available" data-type="number" data-column="1" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center input-available" data-type="number" data-column="2" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center input-available" data-type="number" data-column="5" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center input-available" data-type="number" data-column="8" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center input-available" data-type="number" data-column="3" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center input-available" data-type="number" data-column="4" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center input-available" data-type="number" data-column="10" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center input-available" data-type="number" data-column="61" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center input-available" data-type="number" data-column="7" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center input-available" data-type="number" data-column="99" onchange="sum(this, ['1', '2', '5', '8', '3', '4', '10', '61', '7', '99'], 'row_total', true)"></td>
            <td class="text-center" data-column="row_total" onchange="sub(this, ['row_total'], '#va')" style="border-right: 1px solid #ddd!important;"></td>
        </tr>
    </tbody>
</table>
<table class="table table-bordered table-form">
    <colgroup>
        <col width="120"/>
        <col width="120"/>
        <col width="120"/>
        <col width="120"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
    </colgroup>
    <thead>
        <tr>
			<th class="sub-title colorN text-center border_right" colspan="4">옵션현황</th>
			<th class="sub-title color-contract text-center border_right" colspan="6">모델하우스 설치 기준표</th>
			<th class="sub-title color-contract text-center border_right" colspan="10">옵션행사 실행 기준표(4일기준)</th>
        </tr>
        <tr data-row="option_row">
            <td class="colorSky text-center">옵션율</td>
            <td class="text-center input-available" data-type="string" data-column="option_rate"></td>
            <td class="colorSky text-center" rowspan="2">예상 옵션 세대수</td>
            <td class="text-center input-available border_right" data-type="string" data-column="option_count" rowspan="2"></td>
            <td class="text-center">구분</td>
            <td class="text-center">1TYPE</td>
            <td class="text-center">2TYPE</td>
            <td class="text-center">3TYPE</td>
            <td class="text-center">4TYPE</td>
            <td class="text-center border_right">5TYPE</td>
            <td class="text-center">구분</td>
            <td class="text-center">분양(%)</td>
            <td class="text-center">500세대</td>
            <td class="text-center">750세대</td>
            <td class="text-center">1,000세대</td>
            <td class="text-center">1,250세대</td>
            <td class="text-center">1,500세대</td>
            <td class="text-center">1,750세대</td>
            <td class="text-center">2,000세대</td>
            <td class="text-center">참조</td>
        </tr>
        <tr data-row="option_row">
            <td class="colorSky text-center">모델하우스 설치</td>
            <td class="text-center input-available" data-type="string" data-column="option_model"></td>
            <td class="text-center" rowspan="2">서울권</td>
            <td class="text-center" rowspan="2">800</td>
            <td class="text-center" rowspan="2">1400</td>
            <td class="text-center" rowspan="2">2100</td>
            <td class="text-center" rowspan="2">2800</td>
            <td class="text-center border_right" rowspan="2">3500</td>
            <td class="text-center" rowspan="2">서울권</td>
            <td class="text-center">90</td>
            <td class="text-center">400</td>
            <td class="text-center">600</td>
            <td class="text-center">800</td>
            <td class="text-center">1100</td>
            <td class="text-center">1400</td>
            <td class="text-center">1850</td>
            <td class="text-center" rowspan="2">2000</td>
            <td class="text-center" rowspan="2">서울지역</td>
        </tr>
        <tr>
            <td class="sub-title colorN text-center border_right" colspan="4">특이사항</td>
            <td class="text-center">100</td>
            <td class="text-center">500</td>
            <td class="text-center">725</td>
            <td class="text-center">950</td>
            <td class="text-center">1225</td>
            <td class="text-center">1500</td>
            <td class="text-center">1750</td>
        </tr>
        <tr data-row="option_row">
            <td class="text-center input-available border_right" colspan="4" rowspan="8" data-type="string" data-column="option_bigo"></td>
            <td class="text-center" rowspan="4">수도권</td>
            <td class="text-center" rowspan="4">800</td>
            <td class="text-center" rowspan="4">1400</td>
            <td class="text-center" rowspan="4">2100</td>
            <td class="text-center" rowspan="4">2800</td>
            <td class="text-center" rowspan="4">3500</td>
            <td class="text-center" rowspan="4">수도권</td>
            <td class="text-center">70</td>
            <td class="text-center">300</td>
            <td class="text-center">390</td>
            <td class="text-center">480</td>
            <td class="text-center">540</td>
            <td class="text-center">600</td>
            <td class="text-center">800</td>
            <td class="text-center">1000</td>
            <td class="text-center" rowspan="4">경기지역, <br/>광역시</td>
        </tr>
        <tr>
            <td class="text-center">80</td>
            <td class="text-center">300</td>
            <td class="text-center">405</td>
            <td class="text-center">510</td>
            <td class="text-center">555</td>
            <td class="text-center">600</td>
            <td class="text-center">1150</td>
            <td class="text-center" rowspan="3">1500</td>
        </tr>
        <tr>
            <td class="text-center">90</td>
            <td class="text-center">350</td>
            <td class="text-center">450</td>
            <td class="text-center">550</td>
            <td class="text-center">600</td>
            <td class="text-center">650</td>
            <td class="text-center">1075</td>
        </tr>
        <tr>
            <td class="text-center">100</td>
            <td class="text-center">450</td>
            <td class="text-center">525</td>
            <td class="text-center">600</td>
            <td class="text-center">650</td>
            <td class="text-center">700</td>
            <td class="text-center">1100</td>
        </tr>
        <tr>
            <td class="text-center" rowspan="4">지방권</td>
            <td class="text-center" rowspan="4">850</td>
            <td class="text-center" rowspan="4">1500</td>
            <td class="text-center" rowspan="4">2250</td>
            <td class="text-center" rowspan="4">3000</td>
            <td class="text-center" rowspan="4">3750</td>
            <td class="text-center" rowspan="4">지방권</td>
            <td class="text-center">70</td>
            <td class="text-center">240</td>
            <td class="text-center">445</td>
            <td class="text-center">650</td>
            <td class="text-center">675</td>
            <td class="text-center">700</td>
            <td class="text-center">1000</td>
            <td class="text-center" rowspan="2">1300</td>
            <td class="text-center" rowspan="4">제주포함</td>
        </tr>
        <tr>
            <td class="text-center">80</td>
            <td class="text-center">260</td>
            <td class="text-center">455</td>
            <td class="text-center">650</td>
            <td class="text-center">675</td>
            <td class="text-center">700</td>
            <td class="text-center">1000</td>
        </tr>
        <tr>
            <td class="text-center">90</td>
            <td class="text-center">280</td>
            <td class="text-center">515</td>
            <td class="text-center">750</td>
            <td class="text-center">750</td>
            <td class="text-center">750</td>
            <td class="text-center">1125</td>
            <td class="text-center" rowspan="2">1500</td>
        </tr>
        <tr>
            <td class="text-center">100</td>
            <td class="text-center">300</td>
            <td class="text-center">550</td>
            <td class="text-center">800</td>
            <td class="text-center">800</td>
            <td class="text-center">800</td>
            <td class="text-center">1150</td>
        </tr>

    </thead>
</table>

<script>
    getTag = function(pTag, row){
        var tag = null;
        if(pTag.startsWith("#")){
            tag = $(pTag);
        }
        else if(row == undefined){
            tag = $(`[data-column='${pTag}']`);
        }
        else{
            tag = $(`[data-row="${row}"] [data-column='${pTag}']`);
        }
        return tag;
    }
    getValues = function(tags, row){
        var result = [];
        $.each(tags, function(pIndex, pTag){
            var tag_maybe = getTag(pTag, row);
            $.each($(tag_maybe), function(pI, tag){
                var value = parseInt($(tag).html().replaceAll(",", "")); if(isNaN(value)) value=0;
                result.push(value);
            });
        });
        return result;
    }
    rate = function(own, tags, target, row=undefined){
        if(row) row = $(own).parent().data("row");
        let values = getValues(tags, row);
        let result = 0;
        $.each(values, function(pIndex, pValue){
            if(pIndex == 0)
                result = pValue*100;
            else
                result /= pValue;
        });
        var final_target = getTag(target, row);
        $(final_target).html(result.toFixed(1)+"%");
        $(final_target).trigger("change");
    }
    sub = function(own, tags, target, row=undefined){
        if(row) row = $(own).parent().data("row");
        let values = getValues(tags, row);
        let result = 0;
        $.each(values, function(pIndex, pValue){
            if(pIndex == 0)
                result += pValue;
            else
                result -= pValue;
        });
        var final_target = getTag(target, row);
        $(final_target).html(result.toFormat('NUMBER'));
        $(final_target).trigger("change");
    }
    multiply = function(own, tags, target, row=undefined){
        if(row) row = $(own).parent().data("row");
        let values = getValues(tags, row);
        let result = 1;
        $.each(values, function(pIndex, pValue){
            result *= pValue;
        });
        var final_target = getTag(target, row);
        $(final_target).html(result.toFormat('NUMBER'));
        $(final_target).trigger("change");
    }
    sum = function(own, tags, target, row=undefined){
        if(row) row = $(own).parent().data("row");
        let values = getValues(tags, row);
        let result = 0;
        $.each(values, function(pIndex, pValue){
            result += pValue;
        });
        var final_target = getTag(target, row);
        $(final_target).html(result.toFormat('NUMBER'));
        $(final_target).trigger("change");
    }
    fnValidate = function(){
                    var result = true;
                    return result;
               }
    {% if init %}
    $(document).on("click", "#addRow", function(){
        var trs = $(document).find("tbody[role='row'] tr");
        var origin = trs.eq(0).clone(true);
        $(origin).find("td").html("0");
        $(origin).find("td.input-available").html("");
        $(origin).attr("data-row", trs.length+1);
        $(origin).find(".no-clone").remove();
        $(document).find("tbody[role='row']").append($(origin));
        $(document).find("tbody[role='row'] #total").attr("rowspan", trs.length+1);
    });
    window.projects = {};
    $(document).ready(function(){
        $.ajax({
            url : '/api/project/get_b_projects',
            method: 'GET',
            success: function(pResult){
                var html = `<option value="">[전체]</option>`;
                $.each(pResult, function(pIndex, pValue){
                    html += `<option value="${pValue.cntrct_sn}">${pValue.spt_nm}</option>`;
                    window.projects[pValue.cntrct_sn] = pValue;
                });
                $(document).find("#cntrct_sn").html(html);


            }
        });
    });
    $(document).on("change", "#cntrct_sn", function(){
        var cntrct_sn = $("#cntrct_sn").find(":selected").val();
        if(cntrct_sn != ''){
            var pValue = window.projects[cntrct_sn];
            $("#cntrct_no").val(pValue.cntrct_no);
            $("#home_count").val(pValue.home_count);
            $("#home_region").val(pValue.home_region);
            $("#cntrwk_period").val(pValue.cntrwk_period);
        }
    });
    {% endif %}
</script>