{% include "approvals/common_style.html" %}
<style>
    .input-available{
        height:36px!important;
    }
    table.table-bordered td:last-child, table.table-bordered th:last-child {
        border-right-width: 1px!important;
    }
    .jarviswidget td:last-child, .jarviswidget th:last-child {
        border-right:1px solid #ddd;
    }
</style>
<table class="table table-bordered table-form sub-table" style="width:35%!important;">
    <colgroup>
        <col width="25%">
        <col width="25%">
        <col width="25%">
        <col width="25%">
    </colgroup>
    <thead>
        <tr>
            <th colspan="4" class="sub-title colorN text-center"><span>현 장 현 황</span></th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td class="colorSky text-center">계약번호</td>
            <td class="hasinput" colspan="3"><input type="text" class="form-control text-center" name="cntrct_no" id="cntrct_no" readonly></td>
        </tr>
        <tr>
            <td class="colorSky text-center">현장명</td>
            <td class="text-center hasinput" colspan="3">
                <select class="form-control select2 w100p" id="cntrct_sn" name="cntrct_sn" style="padding-top:0px!important;padding-bottom:0px!important;">
                    {% if not init %}
                        <option value=""></option>
                        {% for code in contract_list %}
                        <option value="{{code.value}}">{{code.etc1}} {{code.label}}</option>
                        {% endfor %}
                    {% endif %}
                </select>

            </td>
        </tr>
        <tr>
            <td class="colorSky text-center">세대수</td>
            <td class="hasinput"><input type="text" class="form-control text-center" name="home_count" id="home_count" readonly></td>
            <td class="colorSky text-center">지역</td>
            <td class="hasinput"><input type="text" class="form-control text-center" name="home_region" id="home_region" readonly></td>
        </tr>
        <tr>
            <td class="colorSky text-center">공사기간</td>
            <td class="hasinput" colspan="3"><input type="text" class="form-control text-center" name="cntrwk_period" id="cntrwk_period" readonly></td>
        </tr>
    </tbody>
</table>
<!-- 공사변경 part0 (id="costTable")-->
<table class="table table-bordered table-form main-table" id="costTable">
    <colgroup>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
        <col width="100"/>
    </colgroup>
    <thead>
        <tr>
			<th class="sub-title colorN text-center" colspan="15"><span>공사 현황</span><span class="text-right">VAT포함</span></th>
        </tr>
    </thead>
    <tbody role="header">
        <tr>
            <th class="colorB text-center">구분</th>
            <th class="color-contract text-center">내역</th>
            <th class="color-contract text-center">삼성장비</th>
            <th class="color-contract text-center">타사장비</th>
            <th class="color-contract text-center">도급비</th>
            <th class="color-contract text-center">로지텍자재</th>
            <th class="color-contract text-center">타사자재</th>
            <th class="color-contract text-center">간접비</th>
            <th class="color-contract text-center">M,S/H(기준표)</th>
            <th class="color-contract text-center">옵션행사비(기준표)</th>
            <th class="color-contract text-center">기타(총액 0.5%)</th>
            <th class="color-contract text-center">설계변경</th>
            <th class="color-contract text-center">총액</th>
            <th class="color-contract text-center">이익금(VA)</th>
            <th class="color-contract text-center">VA율</th>
        </tr>
    </tbody>
    <tbody role="ct_se_code_contract">
        <tr data-row="C">
            <th class="colorB text-center middle" rowspan="2">수주계약</th>
            <th class="colorSky text-center">예정가</th>
            <td class="text-right" data-type='number' name="C_1"></td>
            <td class="text-right" data-type='number' name="C_2"></td>
            <td class="text-right" data-type='number' name="C_5"></td>
            <td class="text-right" data-type='number' name="C_3"></td>
            <td class="text-right" data-type='number' name="C_4"></td>
            <td class="text-right" data-type='number' name="C_8"></td>
            <td class="text-right" data-type='number' name="C_61"></td>
            <td class="text-right" data-type='number' name="C_7"></td>
            <td class="text-right" data-type='number' name="C_10"></td>
            <td class="text-right" data-type='number' name="C_99"></td>
            <td class="text-center" data-column="row_total"></td>
            <td class="text-center" data-column="va" rowspan="2"></td>
            <td class="text-center" data-column="va_rate" rowspan="2"></td>
        </tr>
        <tr data-row="E">
            <th class="colorSky text-center">실행가</th>
            <td class="text-right" data-type='number' name="E_1"></td>
            <td class="text-right" data-type='number' name="E_2"></td>
            <td class="text-right" data-type='number' name="E_5"></td>
            <td class="text-right" data-type='number' name="E_3"></td>
            <td class="text-right" data-type='number' name="E_4"></td>
            <td class="text-right" data-type='number' name="E_8"></td>
            <td class="text-right" data-type='number' name="E_61"></td>
            <td class="text-right" data-type='number' name="E_7"></td>
            <td class="text-right" data-type='number' name="E_10"></td>
            <td class="text-right" data-type='number' name="E_99"></td>
            <td class="text-center" data-column="row_total"></td>
        </tr>
    </tbody>
</table>

<table class="table table-bordered table-form sub-table" id="rptTable12">
	<colgroup>
		<col width="145">
		<col width="150">
		<col width="*">
	</colgroup>
    <thead>
		<tr>
			<th class="sub-title colorN text-center" colspan="6"><span>⑨ 기타비용</span></th>
		</tr>
    </thead>
	<tbody>
		<tr>
			<th class="color-contract text-center">일자</th>
			<th class="color-contract text-center">계정과목</th>
			<th class="color-contract text-center">내역</th>
			<th class="color-contract text-center">지출자</th>
			<th class="color-contract text-center">금액</th>
			<th class="color-contract text-center">비고</th>
		</tr>
	</tbody>
	<tbody role="body"></tbody>
	<tfoot>
		<tr>
			<th class="colorG" colspan="4">합계</th>
			<th class="colorP text-number"></th>
			<th class="colorG"></th>
		</tr>
	</tfoot>
</table>
<table class="table table-bordered table-form main-table">
	<colgroup>
		<col width="100">
		<col width="100">
		<col width="100">
		<col width="100">
		<col width="100">
		<col width="100">
		<col width="100">
		<col width="100">
		<col width="100">
	</colgroup>
	<thead>
		<tr>
			<th class="sub-title colorN text-center" colspan="9"><span style="position:absolute;left:50%;top:50%;transform:translate(-50%, -50%);">지급현황</span>
                <div class="btn-group" style="position:absolute;top:50%;transform:translateY(-50%);right:0;">
                    <button type="button" class="btn btn-table btn-warning" title="추가" id="addRow"><i class="fa fa-plus"></i></button>
                </div>
            </th>
		</tr>
    </thead>
    <tbody role="header">
		<tr>
			<th class="color-contract text-center">A/S일자</th>
			<th class="color-contract text-center">동 호수</th>
			<th class="color-contract text-center">내역</th>
			<th class="color-contract text-center">업체명</th>
			<th class="color-contract text-center">A/S기사</th>
			<th class="color-contract text-center">A/S비용</th>
			<th class="color-contract text-center">지급방법</th>
			<th class="color-contract text-center">영수증 처리여부</th>
			<th class="color-contract text-center">비고</th>
		</tr>
	</tbody>
    <tbody role="as_list_row">
        <tr data-row="as_list_tr">
            <td class="hasinput">
                <input type="text" class="form-control text-center" data-type="date" name="as_date[]"/>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-center" name="as_dong[]"/>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-center" name="as_name[]"/>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-center" name="as_company[]"/>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-center" name="as_human[]"/>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-right" data-type="number" name="as_money[]"/>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-left" name="as_method[]"/>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-center" name="as_bill[]"/>
            </td>
            <td class="hasinput">
                <input type="text" class="form-control text-left" name="as_rm[]"/>
            </td>
        </tr>
    </tbody>
	<tfoot>
		<tr>
			<th class="colorG" colspan="5">합계</th>
			<th class="colorG text-number" data-column="total_as"></th>
			<th class="colorG"></th>
			<th class="colorG"></th>
			<th class="colorG"></th>
		</tr>
	</tfoot>
</table>
<table class="table table-bordered table-form small-table" style="width:100%!important;">
    <colgroup>
        <col width="120"/>
        <col width="120"/>
        <col width="120"/>
        <col width="120"/>
    </colgroup>
    <thead>
        <tr>
			<th class="sub-title colorN text-center border_right" colspan="4"><span>특이사항</span></th>
        </tr>
    </thead>
    <tbody>
        <tr data-row="option_row">
            <td class="hasinput" colspan="4">
               <textarea style="width:100%;height:100%;resize:none;border:none;" name="option_bigo"></textarea>
            </td>
        </tr>
    </tbody>
</table>

<script>
    function isValidDate(dateString) {
      var regEx = /^\d{4}-\d{2}-\d{2}$/;
      if(!dateString.match(regEx)) return false;  // Invalid format
      var d = new Date(dateString);

      var dNum = d.getTime();
      if(!dNum && dNum !== 0) return false; // NaN value, Invalid date
      return (new Date(d.getTime()-(new Date()).getTimezoneOffset())).toISOString().slice(0,10) === dateString;
    }
    get_cost = function(cntrct_sn){
        $.ajax({
            url : '/api/project/get_costs_bd',
            method : 'GET',
        {% if init %}
                data : {"s_cntrct_sn" : cntrct_sn},
        {% else %}
                data : {"s_cntrct_sn" : cntrct_sn, "approval_sn" : window.approval_sn},
        {% endif %}
            success: function(pResult){
                $(document).find("tbody[role='ct_se_code_contract'] input").attr("disabled", false);
                $(document).find("tbody[role='option'] input, tbody[role='option'] select").attr("disabled", false);


                    // 공사변경 part1 START
                    var max_extra_sn = 0;
                    var html = '';
                    $.each(Object.keys(pResult.extraCostList).sort(), function(pIndex, extra_sn){
                        max_extra_sn = extra_sn;
                        var pRow = pResult.extraCostList[extra_sn];
                        html += `<tbody role="ct_se_code_extra" data-row="${extra_sn}">
                                        <tr data-row="C">
                                            <th class="colorB text-center middle" rowspan="2">변경-${extra_sn}</th>
                                            <th class="colorSky text-center">변경 계약가</th>
                                            <td class="text-right" data-type='number' name="C_1_${extra_sn}"></td>
                                            <td class="text-right" data-type='number' name="C_2_${extra_sn}"></td>
                                            <td class="text-right" data-type='number' name="C_5_${extra_sn}"></td>
                                            <td class="text-right" data-type='number' name="C_3_${extra_sn}"></td>
                                            <td class="text-right" data-type='number' name="C_4_${extra_sn}"></td>
                                            <td class="text-right" data-type='number' name="C_8_${extra_sn}"></td>
                                            <td class="text-right" data-type='number' name="C_61_${extra_sn}"></td>
                                            <td class="text-right" data-type='number' name="C_7_${extra_sn}"></td>
                                            <td class="text-right" data-type='number' name="C_10_${extra_sn}"></td>
                                            <td class="text-right" data-type='number' name="C_99_${extra_sn}"></td>
                                            <td class="text-center" data-column="row_total_${extra_sn}"></td>
                                            <td class="text-center" data-column="va_${extra_sn}" rowspan="2"></td>
                                            <td class="text-center" data-column="va_rate_${extra_sn}" rowspan="2"></td>
                                        </tr>
                                        <tr data-row="E">
                                            <th class="colorSky text-center">변경 실행가</th>
                                            <td class="text-right" data-type='number' name="E_1_${extra_sn}"></td>
                                            <td class="text-right" data-type='number' name="E_2_${extra_sn}"></td>
                                            <td class="text-right" data-type='number' name="E_5_${extra_sn}"></td>
                                            <td class="text-right" data-type='number' name="E_3_${extra_sn}"></td>
                                            <td class="text-right" data-type='number' name="E_4_${extra_sn}"></td>
                                            <td class="text-right" data-type='number' name="E_8_${extra_sn}"></td>
                                            <td class="text-right" data-type='number' name="E_61_${extra_sn}"></td>
                                            <td class="text-right" data-type='number' name="E_7_${extra_sn}"></td>
                                            <td class="text-right" data-type='number' name="E_10_${extra_sn}"></td>
                                            <td class="text-right" data-type='number' name="E_99_${extra_sn}"></td>
                                            <td class="text-center" data-column="row_total_${extra_sn}"></td>
                                        </tr>
                                    </tbody>`;
                    });
                    $(document).find("#costTable tbody[role='ct_se_code_contract']").after(html);
                    $.each(Object.keys(pResult.extraCostList).sort(), function(pIndex, extra_sn){
                        var pRow = pResult.extraCostList[extra_sn];
                        $.each(pRow, function(pIndex, pValue){
                            $(document).find(`[name="${pValue.cntrct_execut_code}_${pValue.ct_se_code}_${extra_sn}"]`).html(pValue.amount.toFormat('NUMBER'));
                        });
                        $(document).find(`tbody[data-row='${extra_sn}']`).trigger("change");
                    });
                    // 공사변경 part1 END
                    $(document).find("tbody[role='ct_se_code_contract'] input").attr("disabled", false);
                    $(document).find("tbody[role='equip_row'] input, tbody[role='equip_row'] select").attr("disabled", false);
                    $.each(pResult.aCostList, function(pIndex, pValue){
                        $(document).find(`[name="${pValue.cntrct_execut_code}_${pValue.ct_se_code}"]`).html(pValue.amount.toFormat('NUMBER'));
                    });
                    $(document).find("tbody[role='ct_se_code_contract']").trigger("change");
                    var totals = [];
                    $("tbody[role='ct_se_code_contract']").find("tr").each(function(pIndex, pRow){
                        var total = 0;
                        $(pRow).find("[data-type='number']").each(function(pI, pTag){
                            var value = parseInt($(pTag).html().replaceAll(",", "")); if(isNaN(value)) value = 0;
                            total += value;
                        });
                        $(pRow).find("[data-column='row_total']").html(total.toFormat('NUMBER'));
                        totals.push(total);
                    });

                    $("tbody[role='ct_se_code_contract']").find("[data-column='va']").html((totals[0] - totals[1]).toFormat('NUMBER'));
                    $("tbody[role='ct_se_code_contract']").find("[data-column='va_rate']").html(((totals[0] - totals[1])*100.0/totals[0]).toFixed(1)+"%");

				var html = '';
				var etcRcppayList = pResult.etcRcppayList;
				var amt_total = 0;
				$.each(etcRcppayList, function(pIndex, pValue) {
					var amt = parseInt(pValue.amount);
					html += '<tr>';
					html += '    <td class="">'+pValue.rcppay_de+'</td>';
					html += '    <td class="">'+pValue.acntctgr_nm+'</td>';
					html += '    <td class="text-left">'+pValue.rcppay_dtls+'</td>';
					html += '    <td class="">'+pValue.papr_invstmnt_nm+'</td>';
					html += '    <td class=" text-number">'+amt.toString().toFormat('NUMBER')+'</td>';
					html += '    <td class=""></td>';
					html += '</tr>';
					amt_total += parseInt(amt);
				});

				$(document).find('#rptTable12 tbody[role=body]').html(html);
				$(document).find('#rptTable12 tfoot th:eq(1)').html(amt_total.toString().toFormat('NUMBER'));

            }
        });

    }
    cloneRow = function(selector, count){
        if(selector == "as_list_tr"){
            for(let i=0;i<count;i++) {
                var trs = $(document).find("tbody[role='as_list_row'] tr");
                var origin = trs.eq(0).clone(true);
                $(origin).find("td:not(.hasinput)").html("");
                $(origin).find("td.hasinput input").val("");
                $(document).find("tbody[role='as_list_row']").append($(origin));
            }
            $(document).find("tbody[role='as_list_row']").trigger("change");
        }
    }
    $(document).on("change", "tbody[role='as_list_row']", function(){
        var total_amount = 0;
        $(this).find("tr").each(function(pIndex, pRow){
            var damt = parseInt($(pRow).find(`input[name='as_money[]']`).val().replaceAll(",", "")); if(isNaN(damt)) damt = 0;
            total_amount += damt;
        });
        $(document).find(`[data-column='total_as']`).html(total_amount.toFormat('NUMBER'));

    });
    fnValidate = function(){
                    var result = true;
                    return result;
               }
    {% if init %}
    $(document).on("click", "#addRow", function(){
        cloneRow("as_list_tr", 1);
    });
    		if(window.projects == undefined){
			window.projects = {};
		}

    $(document).ready(function(){
        $(document).find("tbody[role='ct_se_code_contract'] input").attr("disabled", true);
        $(document).find("tbody[role='option'] input, tbody[role='option'] select").attr("disabled", true);
        $.ajax({
            url : '/api/project/get_p_projects',
            method: 'GET',
            success: function(pResult){
                var cntrct_sn = $(document).find("#cntrct_sn").val();
                var html = `<option value="">[전체]</option>`;
                $.each(pResult, function(pIndex, pValue){
                    if(cntrct_sn != '' && (parseInt(pValue.cntrct_sn) == parseInt(cntrct_sn))){
                        html += `<option value="${pValue.cntrct_sn}" selected>${pValue.cntrct_no} ${pValue.spt_nm}</option>`;
                    }
                    else{
                        html += `<option value="${pValue.cntrct_sn}">${pValue.cntrct_no} ${pValue.spt_nm}</option>`;
                    }
                    window.projects[pValue.cntrct_sn] = pValue;
                });
                $(document).find("#cntrct_sn").html(html);

            }
        });
        var input = document.querySelector('input[data-type="number"]');
        if(input){
            input.addEventListener('input', function() {
              this.value = this.value.replace(/[^0-9 \,]/, '');
            });

        }
    });
    $(document).on("focusout", "input[data-type='number']", function(){
        var value = $(this).val().replaceAll(",", "").toFormat('NUMBER');
        $(this).val(value);
    });
    $(document).on("focusout", "input", function(){
        $(this).closest("tbody").trigger("change");
    });
    $(document).on("focusout", "input[data-type='date']", function(){
        if(!isValidDate($(this).val()) && $(this).val() != ''){
            alert("날짜 형식이 올바르지 않습니다. (yyyy-mm-dd)");
            $(this).val("");
        }
    });

    $(document).on("keyup", "input", function(e){
        if(e.keyCode == 13){
            $(this).focusout();
        }
    });

    $(document).on("change", "#cntrct_sn", function(){
        var cntrct_sn = $("#cntrct_sn").find(":selected").val();
        if(cntrct_sn != ''){
            var pValue = window.projects[cntrct_sn];
            $("#cntrct_no").val(pValue.cntrct_no);
            $("#home_count").val(pValue.home_count);
            $("#home_region").val(pValue.home_region);
            $("#cntrwk_period").val(pValue.cntrwk_period);
            get_cost(cntrct_sn);
        }
    });
    {% else %}
    $.fn.afterLoadApproval = function() {
        var cntrct_sn = $("#cntrct_sn").find(":selected").val();
        get_cost(cntrct_sn);

    }
    {% endif %}
</script>