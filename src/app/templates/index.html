{% extends 'common/main_base.html' %}
{% block content %}
<!--<div id="ribbon" style="background:#B3E5FC!important;">-->
<!--	<span class="ribbon-button-alignment">-->
<!--		<span id="refresh" class="btn btn-ribbon" data-action="resetWidgets" data-title="refresh"  rel="tooltip" data-placement="bottom" data-original-title="<i class='text-warning fa fa-warning'></i> Warning! This will reset all your widget settings." data-html="true">-->
<!--			<i class="fa fa-refresh"></i>-->
<!--		</span>-->
<!--	</span>-->
<!--    <ol class="breadcrumb">-->
<!--        <li style="">홈</li><li><span> 홈</span></li>-->
<!--	</ol>-->
<!--</div>-->
<style>
  #my-spinner { width: 100%; height: 100%; top: 0; left: 0; display: none; opacity: .6; background: silver; position: absolute; z-index: 2; }
  #my-spinner div { width: 100%; height: 100%; display: table; }
  #my-spinner span { display: table-cell; text-align: center; vertical-align: middle; }
  #my-spinner img { background: white; padding: 1em; border-radius: .7em; }
</style>
<script src="/static/summernote/summernote-lite.js"></script>
<script src="/static/summernote/summernote-ko-KR.js"></script>
<link href="/static/summernote/summernote-lite.css" rel="stylesheet"/>
<div id='my-spinner'>
  <div>
    <span>
    	<img src='//cdnjs.cloudflare.com/ajax/libs/galleriffic/2.0.1/css/loader.gif'>
    </span>
  </div>
</div>

<div id="content" style="padding-top:30px!important;height:calc(100vh - 138px);">
	<input type="file" name="myFile" id="ex_filename" style="display:none;">
	<!-- 화면 내용 -->
	<section id="widget-grid" class="" style="height:100%;">

		<!-- row -->
		<div class="row report" style="height:100%;">
			<style>
				.grid-container{
					display:grid;
					grid-template-columns: 300px 1fr;
					column-gap: 20px;
					height:100%;
				}
				.left-container{
					height:100%;
					display:grid;
					grid-template-rows: 200px 1.5fr 1fr;
					row-gap:15px;
				}
				.right-container{
					height:100%;
					display:grid;
					grid-template-rows: 1fr 1fr 1fr 1fr;
					row-gap:15px;
				}
				.left-container > div:first-child{
					background-color: #002060;
				}
				.right-container > div{
					/*border: 1px solid #333;*/
				}
				.profile-container{
					display:grid;
					padding-right:10px;
					padding-left:10px;
					grid-template-rows: 5fr 1fr;
					color: white;
				}
				.profile{
					display:grid;
					grid-template-columns: 1fr 1fr;
					place-items: center center;
				}
				.profile > div:first-child > img{
					border-radius: 50%;
					width: 80%;
					aspect-ratio: 1.0;
				}
				.profile > div:last-child{
					width: 80%;
					display:grid;
					grid-template-rows: 1fr 1fr 1fr;
					place-items: start start;
					row-gap: 10px;
				}
				.table-container{
					display:grid;
					grid-template-rows: 30px 1fr;
				}
				.table-container > div {
					padding-left: 10px;
					padding-right: 10px;
				}
				.table-container div:first-child span:first-child, .attendance-container span:first-child{
					font-size:15px!important;
				}
				.table-container > div:first-child {
					display: grid;
					grid-template-columns: 100px 1fr 60px;
				}

				div.report .table-container thead tr th{
					background-color:#002060!important;
					color:white;
				}

				div.report .table-container table {
					border: 1px solid #002060!important;
				}
				div.report .table-container thead, div.report .table-container tbody, div.report .table-container tbody[role=header], div.report .table-container tbody[role=body], div.report .table-container tbody[role=footer], div.report .table-container tfoot {
					border: 1px solid #002060!important;
				}
				.attendance-container{
					display:grid;
					grid-template-rows: 30px 1fr 30px;
				}
				.attendance-container > div{
					border:1px solid #002060!important;
					padding-left: 10px;
					padding-right: 10px;
					display: flex;
					justify-content: center;
					align-items: center;
					gap: 20px;

				}
				.attendance-container > div:last-child{
					border-top:none!important;
					cursor:pointer;
					color:#002060;
					transition: 0.3s;
				}
				.attendance-container > div:last-child:hover{
					background-color:#002060;
					color:white;
				}
				.circle {
					height: 120px;
				    width: 120px;
				    background-color: #bbb;
				    border-radius: 50%;
				    display: grid;
					padding-top:10px;
					padding-bottom:20px;
					text-align:center;
					opacity:0.8;

				}
				.active {
					background-color: #002060;
					color:white;
				}
				.table-form{
					border:1px solid #002060!important;
					display:grid;
					grid-template-rows: 34px 110px;
				}
				.table-thead{
					display:grid;
					grid-template-columns: 2fr 4.5fr 1.75fr 1.75fr;
				}
				.table-thead-five{
					display:grid;
					grid-template-columns: 2fr 4.5fr 1.75fr 1.75fr 1.75fr;
				}
				.table-thead > div, .table-thead-five > div{
					display: grid;
					justify-content: center;
					align-items: center;
					background-color: #002060;
					color:white;
					font-weight:bold;
					border-right:1px solid #555;
				}
				.table-tbody{
					overflow-y:auto;
					box-sizing:border-box;
					-webkit-box-sizing: border-box;
					-moz-box-sizing: border-box;
				}

				.table-tbody > .table-tr{
					height:27.5px;
					display:grid;
					grid-template-columns: 2fr 4.5fr 1.75fr 1.75fr;
					border-bottom:1px solid #999;
				}
				.table-tbody > .table-tr-five{
					height:27.5px;
					display:grid;
					grid-template-columns: 2fr 4.5fr 1.75fr 1.75fr 1.75fr;
					border-bottom:1px solid #999;
				}
				.table-tbody::-webkit-scrollbar{
					width:2px!important;
				}
				.table-tbody::-webkit-scrollbar-track{
					width:2px!important;
					background:#eee;
				}
				.table-tbody::-webkit-scrollbar-thumb{
					width:2px!important;
					background:#555!important;
				}
				.table-tbody > .table-tr > .table-td, .table-tbody > .table-tr-five > .table-td{
					display: grid;
					justify-content: center;
					align-items: center;
					font-weight:normal!important;
				}
				.table-tbody > .table-tr > .table-td.text-left, .table-tbody > .table-tr-five > .table-td.text-left{
					justify-content: left;
					padding-left:5px;
				}

				.table-tbody > .table-tr > .table-td:not(:last-child), .table-tbody > .table-tr-five > .table-td:not(:last-child){
					border-right:1px solid #999;
				}
				.approval-tr:hover .table-td{
					background-color: #ecf3f8;
				}
				.approval-tr, #approval_status_4 .table-tr{
					cursor:pointer;
				}
				#profile-img{
					cursor:pointer;
				}
				.profile-img-container{
					text-align:center;
					position: relative;
				}
				.profile-img-container > div{
					width: 80%;
					background-color:rgba(0, 0, 0, 0.4);
					position:absolute;
					display:none;
					height:100%;
					left:50%;
					border-radius:50%;
					transform:translateX(-50%);
					grid-template-rows: 1fr 1fr;

				}
				.profile-img-container > div > div{
					display:grid;
					justify-items: center;
					align-items: center;
					cursor:pointer;
				}
				.profile-img-container > div > div:first-child{
					border-bottom:1px solid white;
				}
			</style>
			<div class="grid-container">
				<div class="left-container" style="font-weight: normal!important;">
					<div class="profile-container">
						<div class="profile">
							<div class="profile-img-container">
								<img id="profile-img" src="/static/files/{{session['member']['profile_path'] if session['member']['profile_path'] != '' else 'profile.png'}}" alt="Avatar">
								<div style="top:0px;" id="profile-setup">
									<div id="regist-profile">프로필 등록</div>
									<div id="regist-sign">서명 등록</div>
								</div>
							</div>
							<div>
								<span style="font-size:15px!important;">{{session['member'].member_nm}}</span>
								<span style="font-weight:normal!important;">부서 : <span style="font-weight:normal!important;">{{session['member'].dept_nm}}</span></span>
								<span style="font-weight:normal!important;">직급 : <span style="font-weight:normal!important;">{{session['member'].member_level}}</span></span>
							</div>
						</div>
						<div style="text-align:center;font-weight:normal!important;">
							<i class="fa fa-clock-o" style="font-weight:normal!important;" aria-hidden="true"></i> 최근 로그인 시각 :
							{% if session['member'].login_dtm %}
								<span>{{session['member'].login_dtm}}</span>
							{% else %}
								<span>최초 로그인</span>
							{% endif %}
						</div>
					</div>
					<div id="calendar">
					</div>
					<div class="attendance-container">
						<span>출퇴근기록</span>
						<div>
							<span class="circle" id="start_time">
								<span>출근</span>
								<span class="timer">미등록</span>
							</span>
							<span class="circle" id="end_time">
								<span>퇴근</span>
								<span class="timer">미등록</span>
							</span>
						</div>
						<div id="attendance">근태관리 바로가기</div>
					</div>
				</div>
				<div class="right-container">
					<div class="table-container">
						<div>
							<span>결재문서</span>
							<span></span>
							<span><a href="/approval?type=미결">전체보기</a></span>
						</div>
						<div>
							<div class="table-form" style="grid-template-rows: 34px 164px!important;">
								<div class="table-thead-five">
									<div>양식</div>
									<div>제목</div>
									<div>기안자</div>
									<div>결재완료자</div>
									<div>기안일</div>
								</div>
								<div class="table-tbody" id="approval_status_1">
								</div>
							</div>

						</div>
					</div>
					<div class="table-container">
						<div>
							<span>진행문서</span>
							<span></span>
							<span><a href="/approval?type=진행">전체보기</a></span>
						</div>
						<div>
							<div class="table-form">
								<div class="table-thead-five">
									<div>양식</div>
									<div>제목</div>
									<div>기안자</div>
									<div>결재완료자</div>
									<div>기안일</div>
								</div>
								<div class="table-tbody" id="approval_status_2">
								</div>
							</div>

						</div>
					</div>
					<div class="table-container">
						<div>
							<span>수신문서</span>
							<span></span>
							<span><a href="/approval">전체보기</a></span>
						</div>
						<div>
							<div class="table-form" style="grid-template-rows: 34px 110px!important;">
								<div class="table-thead">
									<div>양식</div>
									<div>제목</div>
									<div>기안자</div>
									<div>기안일</div>
								</div>
								<div class="table-tbody" id="approval_status_3">
								</div>
							</div>

						</div>
					</div>
					<div class="table-container">
						<div>
							<span>공지사항</span>
							<span></span>
							{% if session['member']['auth_cd'] == 1 %}
							<span><a href="#popReport1" data-target="#popReport1" data-toggle="modal">글쓰기</a></span>
							{% else %}
							<span></span>
							{% endif %}
						</div>
						<div>
							<div class="table-form">
								<div class="table-thead">
									<div>분류</div>
									<div>제목</div>
									<div>작성자</div>
									<div>작성일</div>
								</div>
								<div class="table-tbody" id="approval_status_4">
								</div>
							</div>

						</div>
					</div>
				</div>

			</div>



		</div>
		<!-- end row -->
	</section>
	<!-- end widget grid -->

</div>
<script>
	$(document).ready(function(){
		var coveredOffset = $('#profile-img').offset(),
			coveredWidth  = $('#profile-img').width(),
			coveredHeight = $('#profile-img').height();
		console.log(coveredOffset, coveredHeight, coveredHeight)
		$(document).on('mousemove', function (event) {
			if (event.pageX > coveredOffset.left && event.pageX < (coveredOffset.left + coveredWidth) && event.pageY > coveredOffset.top && event.pageY < (coveredOffset.top + coveredHeight)) {
				$("#profile-setup").css("display", "grid");
			}
			else{
				$("#profile-setup").css("display", "none");

			}
		});

	});
	$(document).on("click", "#regist-sign", function(e){
		e.preventDefault();
		window.clickFlag = 0;
		$("#ex_filename").click();
	});
	$(document).on("click", "#regist-profile", function(e){
		e.preventDefault();
		window.clickFlag = 1;
		$("#ex_filename").click();

	});
	$(document).on("change", "#ex_filename", function(){
		const file = document.querySelector("#ex_filename").files[0];
		const filesize = file.size;
		var params = {"filesize" : filesize, "ext" : file.name.split(".")[file.name.split(".").length-1], "order" : 0, "folder" : "{{session['member']['member_sn']}}"};
		$.ajax({
			url : '/api/common/get_upload_file_id',
			method : 'POST',
			data : params,
			success: function(pResult){
				let name = pResult.filename;
				let chunk_size = pResult.filesize;
				let file_sn = pResult.file_sn;
				let ord = pResult.order;
				let start = 0;
				create_chunk(ord, file_sn, name, file, chunk_size, start, 0);
			},
			error: function(){
				alert("오류가 발생했습니다.");
					location.reload();
				},
			beforeSend: function(){


			}
		});
	});
    function create_chunk(order, file_sn, name, file, chunk_size, start, idx){
        let chunk_end = Math.min(start + chunk_size , file.size );
        const chunk = file.slice(start, chunk_end);
        const form = new FormData();
        let filename = name.split(".")[0];
        let ext = name.split(".")[1];
        form.append('file', chunk, filename+"."+ext+"."+idx);
        let oReq = new XMLHttpRequest();
        oReq.open("POST", "/api/common/chunk_upload", true);
        let blob_end = chunk_end-1;
        let contentRange = "bytes "+ start+"-"+ blob_end+"/"+file.size;
        oReq.setRequestHeader("Content-Range",contentRange);
        oReq.onload = function(e){
            let pResult = JSON.parse(oReq.response);
            if(!pResult.status){
                alert(pResult.msg);
                return;
            }
            if(start + chunk_size < file.size){
                create_chunk(order, file_sn, name, file, chunk_size, start+chunk_size, idx+1);
            }
            else{
				$.ajax({
					url : `/api/member/ajax_update_image`,
					method : 'POST',
					data : {"file_sn" : file_sn, "purpose": window.clickFlag, "mber_sn" : "{{session['member']['member_sn']}}"},
					success: function(pResult) {
						if(window.clickFlag == 0){
							$("#my-spinner").hide();
							alert("등록되었습니다.");
							location.reload();
						}
						else{
							$("#my-spinner").hide();
							alert("프로필 반영을 위해 로그아웃이 필요합니다.");
							$(document).find("#btnLogout").click();

						}

					},
					error: function(pResult){
						alert("오류가 발생했습니다.");
						// location.reload();
					}
				})
            }
        }
        oReq.send(form);
    }
</script>
<script>
	// var db_events = [{
	// 	title: "Today",
	// 	date: (new Date()).toISOString().split("T")[0]
	// }];
	getTodayWork = function(){
		let offset = (new Date()).getTimezoneOffset() * 60000;
		var today = (new Date((new Date()).getTime()-offset)).toISOString().split("T")[0];
		var params = '';
		params += '&s_today='+today;
		$.ajax({
			url: '/api/work/ajax_today',
			type: 'GET',
			data: params,
			dataType: 'json',
			contentType: false,
			processData: false,
			validate: function() {
				return true;
			},
			success: function(pResult) {
				var pData = pResult.data;
				if(pData.start_time == ''){
					$(document).find("#start_time").removeClass("active");
					$(document).find("#start_time").find(".timer").html("미등록");
				}
				else{
					$(document).find("#start_time").addClass("active");
					$(document).find("#start_time").find(".timer").html(`${pData.start_time.slice(8,10)}:${pData.start_time.slice(10,12)}`);
				}
				if(pData.end_time == ''){
					$(document).find("#end_time").removeClass("active");
					$(document).find("#end_time").find(".timer").html("미등록");
				}
				else{
					$(document).find("#end_time").addClass("active");
					$(document).find("#end_time").find(".timer").html(`${pData.end_time.slice(8,10)}:${pData.end_time.slice(10,12)}`);
				}
			}
		});
	}

	$(document).ready(function(){
		$("#calendar").MEC({
			events: [],
			// from_monday: true
		});
		$("#calTFooter").hide();
		var dates = $(document).find("#calTbody .a-date");
		if(dates.length > 0){
			$.each(dates, function(pIndex, pTag){
				if((pIndex %7) == 6){
					$(pTag).css("color", "skyblue");
				}
				else if((pIndex % 7) == 0){
					$(pTag).css("color", "red");

				}
			});
		}
		$(document).on("click", "#calendar .month-mover", function(){
		var dates = $(document).find("#calTbody .a-date");
		if(dates.length > 0){
			$.each(dates, function(pIndex, pTag){
				if((pIndex %7) == 6){
					$(pTag).css("color", "skyblue");
				}
				else if((pIndex % 7) == 0){
					$(pTag).css("color", "red");

				}
			});
		}

		})
		getTodayWork();
		getApprovalList("미결", "#approval_status_1", 5);
		getApprovalList("진행", "#approval_status_2", 5);
		getApprovalList("수신", "#approval_status_3");
		getBBS();
		// getAlmostDoneProject();

		// if session['member']['dept_code'] == 'BI'
		// getBIMSProject();
		//endif

		$("#attendance").on("click", ()=>(location.href="/work/personal"));
	});
	$(document).on("click", "#calendar button.a-date", function(){
		var clicked = parseInt($(this).text().trim()).toString();
		var monthYear = $("#monthYear").data("date");
		var date = monthYear+"-"+(clicked.padStart(2, "0"));
		$("#popReport7").find("#s_ddt_man").datepicker('setDate', date);
		$("#popReport7").modal("show");
	});
	$(document).on("touchstart", "#calendar button.a-date", function(){
		var clicked = parseInt($(this).text().trim()).toString();
		var monthYear = $("#monthYear").data("date");
		var date = monthYear+"-"+(clicked.padStart(2, "0"));
		$("#popReport7").find("#s_ddt_man").datepicker('setDate', date);
		$("#popReport7").modal("show");
	});
</script>
<link rel="stylesheet" type="text/css" href="/static/nexell/css/smartadmin-nexell-report.css">
<!--<script src="//code.jquery.com/mobile/1.5.0-alpha.1/jquery.mobile-1.5.0-alpha.1.min.js"></script>-->

<!--########################################################################-->
<!--# page layer start                                                     #-->
<!--########################################################################-->
<!-- 매입/매출 레포트 팝업 시작 -->
<div class="modal fade" data-backdrop="static" id="popReport7">
    <div class="modal-dialog modal-w1200" style="width:98%!important;">
        <div class="modal-content">
			<div class="modal-header">
				<div class="pull-right" style="margin-right:10px;">
					<button type="button" class="btn btn-primary" id="btnPrint7"><i class="fa fa-print">&nbsp;출력</i></button>
					<button type="button" class="btn btn-default" aria-hidden="true" data-dismiss="modal"><i class="fa fa-times">&nbsp;취소</i></button>
				</div>
                <div class="pull-right" style="margin-right:10px;width:150px;">
					<div class="input-group">
						<input class="form-control datepicker" type="text" style="z-index:1050!important;" data-dateformat="yy-mm-dd" data-mask="9999-99-99" data-mask-placeholder="_" id="s_ddt_man" name="s_ddt_man">
						<span class="input-group-addon"><i class="fa fa-calendar"></i></span>
					</div>
				</div>

			</div>
			<div class="modal-body report">


				<div id="rpt7">
				<!--<div class="title"><h2 class="colorLS" id="title">팀별 VA 현황</h2></div>-->
				<style>

					#rpt7 .table>tbody>tr>td, #rpt7 .table>tbody>tr>th, #rpt7 .table>tfoot>tr>td, #rpt7 .table>tfoot>tr>th, #rpt7 .table>thead>tr>td, #rpt7 .table>thead>tr>th {
						line-height: 0.5 !important;
						font-size:12px!important;
					}
					#rpt7 .table>tbody[role=header]>tr>td, #rpt7 .table>tbody[role=header]>tr>th,
					#rpt7 .table>tbody[role=top]>tr>td, #rpt7 .table>tbody[role=top]>tr>th,
					#rpt7 .table>tbody[role=chair]>tr>td, #rpt7 .table>tbody[role=chair]>tr>th,
					#rpt7 .table>tbody[role=foot]>tr>td, #rpt7 .table>tbody[role=foot]>tr>th,
					#temp>tbody[role=body]>tr>td, #temp>tbody[role=body]>tr>th
					{
						line-height: 1.0 !important;
						font-size: 15px !important;
					}

					#rpt7 .title>h2 {
						padding:4px 45px!important;
					}

					#rpt7 .table>tbody>tr>td, body.smart-style-6 .modal .table>tfoot>tr>th, body.smart-style-6 .modal .table>tfoot>tr>td, body.smart-style-6 .modal .table>thead>tr>td {
						padding:7px!important;
					}

				</style>
				<div class="title" style="margin-bottom:-5px!important;"><h2 class="colorLS" style="font-size:17px!important;">넥셀시스템 / 일일 업무현황</h2></div>
				<!-- 기성 현황 시작 -->
				<div style="display:grid;grid-template-columns:1fr 1fr 1fr;">
					<h5 class="sub-title" id="rptDate7"></h5>
					<h5></h5>
					<h5 class="sub-title" style="text-align: left!important;">(현)현장 , (영)영업 , (내)내근, (출)출장, (직)직근 / <span style="color:blue;font-size: 17px!important;">당일 9시 이전 기재 완료</span></h5>
				</div>


				<table id="todo" class="table table-bordered w100p">
					 <colgroup>
						<col width="80">
						<col width="100">
						<col width="60">
						<col width="600">
						<col width="600">
					</colgroup>
					<tbody role="header">
						<tr>
							<th class="colorG" colspan="3">구 분</th>
							<th class="colorG" colspan="1">오전</th>
							<th class="colorG" colspan="1">오후</th>
						</tr>
					</tbody>
					<tbody role="top">
						<th class="colorSky" colspan="3">소식알리미(공통)</th>
						<th class="text-left colorW" colspan="1" name="todo_head" data-mber="-1" data-time="0" style="color:blue!important;"></th>
						<th class="text-left colorW" colspan="1" name="todo_head" data-mber="-1" data-time="1" style="color:blue!important;"></th>

					</tbody>
					<tbody role="chair">
						<th class="colorSky" colspan="3">대표이사</th>
						<th class="text-left colorW" colspan="1" name="todo_text" data-mber="4" data-time="0" style="color:blue!important;" ></th>
						<th class="text-left colorW" colspan="1" name="todo_text" data-mber="4" data-time="1" style="color:blue!important;" ></th>

					</tbody>    <tbody role="body">
					</tbody>
					<tbody role="foot">
						<th class="colorSky" colspan="3">공지사항/협조사항(공통)</th>
						<th class="text-left colorW" colspan="1" name="todo_foot" data-mber="-2" data-time="0" style="color:blue!important;"></th>
						<th class="text-left colorW" colspan="1" name="todo_foot" data-mber="-2" data-time="1" style="color:blue!important;"></th>
					</tbody>






				</table>

				<br/>


				</div><!-- 기성 현황 끝 -->


			</div><!--modal-body-->
        </div><!--modal-content-->
    </div><!--modal-dialog-->
</div><!--modal-->
<!-- 매입/매출 레포트 팝업 끝 -->
<script type="text/javascript">
getApprovalList = function(s_approval_status, target, size=4){
	$.ajax({
		url: '/api/approval/ajax_get_approval_datatable',
		type: 'POST',
		data: {"s_approval_status" : s_approval_status},
		success: function (pResult) {
			var html = '';
			console.log(pResult);
			$.each(pResult.data, function(pIndex, pValue){
				if(size == 5){
				html += `<div class="table-tr-five approval-tr" data-sn="${pValue.approval_sn}">
							<div class="table-td">${pValue.approval_ty_nm}</div>
							<div class="table-td text-left">${pValue.approval_title}</div>
							<div class="table-td">${pValue.start_mber_nm}</div>
							<div class="table-td">${pValue.final_mber_nm}</div>
							<div class="table-td">${pValue.start_de}</div>
						</div>`;

				}
				else{
				html += `<div class="table-tr approval-tr" data-sn="${pValue.approval_sn}">
							<div class="table-td">${pValue.approval_ty_nm}</div>
							<div class="table-td text-left">${pValue.approval_title}</div>
							<div class="table-td">${pValue.start_mber_nm}</div>
							<div class="table-td">${pValue.start_de}</div>
						</div>`;

				}
			});
			$(document).find(target).html(html);
		}
	});

}
$(document).on("click", ".approval-tr", function(){
	var approval_sn = $(this).data("sn");
	var params = "";
    params += "&approval_sn="+approval_sn;
    window.open("/approval/report?"+params, "_blank");
});
getBIMSProject = function(){
	var new_window_width = parseInt(screen.width/1.5);
	var new_window_height = parseInt(screen.height) - 20;
	var positionX = screen.width - new_window_width - 10;
	var report = window.open("/index/bnd", "bnds", `width=${new_window_width},height=${new_window_height},left=${positionX}`);

}
getAlmostDoneProject = function(){
	var params = "";
	params += "&s_dept_code=all";
	$.ajax({
		url: '/api/dashboard/ajax_get_projects_by_dept_member',
		type: 'GET',
		data: params,
		dataType: 'json',
		contentType: false,
		processData: false,
		success: function (pResult) {
			console.log(pResult);
			if(pResult.data.length > 0){
				var new_window_width = parseInt(screen.width/1.5);
				var new_window_height = parseInt(screen.height) - 20;
				var positionX = 10;
				var report = window.open("/index/almost", "projects", `width=${new_window_width},height=${new_window_height},left=${positionX}`);

			}
		}
	});
}

getWeek = function(date){
    var week = ['일', '월', '화', '수', '목', '금', '토'];
    var day = new Date(date);
    var dayOfWeek = week[day.getDay()];

    return day.getFullYear()+'년 '+(day.getMonth()+1)+'월 '+(day.getDate())+'일 ('+dayOfWeek+'요일)';
}

insertTodo = function(pMberSN, pTodoTime, pTodoText)
{

	var params = '';
	params += '&mber_sn='+pMberSN;
	params += '&todo_time='+pTodoTime;
	params += '&todo_text='+pTodoText;
	params += '&todo_de='+$('#s_ddt_man').val();
	params += '&regist_sn=0';
	$.ajax({
		url: '/api/member/ajax_insert_todo',
		type: 'GET',
		data: params,
		dataType: 'json',
		contentType: false,
		processData: false,
		validate: function() {
			return true;
		},
		success: function(pResult) {
            getTodo($('#s_ddt_man').val());
		}
	});
}
updateTodo = function(pTodoSN, pMberSN, pTodoTime, pTodoText)
{
	var params = '';
	params += '&todo_sn='+pTodoSN;
	params += '&mber_sn='+pMberSN;
	params += '&todo_time='+pTodoTime;
	params += '&todo_text='+pTodoText;
	params += '&todo_de='+$('#s_ddt_man').val();
	$.ajax({
		url: '/api/member/ajax_update_todo',
		type: 'GET',
		data: params,
		dataType: 'json',
		contentType: false,
		processData: false,
		validate: function() {
			return true;
		},
		success: function(pResult) {
            getTodo($('#s_ddt_man').val());
		},
        error: function(pResult){
            console.log(pResult)
        }
	});
}
getTodo = function(s_ddt_man)
{
    var params = '';
	params += '&s_ddt_man='+s_ddt_man;

	$.ajax({
		url: '/api/member/ajax_get_member_todo',
		type: 'GET',
		data: params,
		dataType: 'json',
		contentType: false,
		processData: false,
		success: function(pResult) {
			console.log('getTodo', pResult);
			var html = '';
            var before = '';
            $.each(pResult.data, function(pIndex, pValue){
                if(pValue.mber_sn == '73' || pValue.mber_sn == '74' || pValue.mber_sn =='81'){
                    return true;
                }
                if(pValue.mber_sn == '4'){

                    $("#rpt7").find("#todo tbody[role=chair] th").eq(1).html(pValue.text_m);
                    $("#rpt7").find("#todo tbody[role=chair] th").eq(2).html(pValue.text_a);
                    var sn_m = parseInt(pValue.sn_m);
                    var sn_a = parseInt(pValue.sn_a);
                    var update_m = ' ';
                    if(sn_m != 0){
                        $("#rpt7").find("#todo tbody[role=chair] th").eq(1).data('sn', sn_m);
                    }
                    else{
                        $("#rpt7").find("#todo tbody[role=chair] th").eq(1).data('sn', '-1');

					}
                    var update_a = ' ';
                    if(sn_a != 0){
                        $("#rpt7").find("#todo tbody[role=chair] th").eq(2).data('sn', sn_a);
                    }
                    else{
                        $("#rpt7").find("#todo tbody[role=chair] th").eq(2).data('sn', '-1');

					}
                }
                else{
                    if(before != '' && before != pValue.dept_nm)
                        html += '<tr style="border-top:solid 2px black !important">';
                    else
                        html += '<tr>';
                    html += '    <td class="text-center colorSky">'+pValue.dept_nm+'</td>';
                    html += '    <td class="text-center">'+pValue.mber_nm+'</td>';
                    html += '    <td class="text-center">'+pValue.ofcps_nm+'</td>';

                    var sn_m = parseInt(pValue.sn_m);
                    var sn_a = parseInt(pValue.sn_a);
                    var update_m = ' ';
                    if(sn_m != 0){
                        update_m = ' data-sn="'+sn_m+'"';
                    }
                    var update_a = ' ';
                    if(sn_a != 0){
                        update_a = ' data-sn="'+sn_a+'"';
                    }
                    html += '    <td class="text-left" name="todo_text" data-mber="'+pValue.mber_sn+'" data-time="0"'+update_m+'>'+pValue.text_m+'</td>';
                    html += '    <td class="text-left" name="todo_text" data-mber="'+pValue.mber_sn+'" data-time="1"'+update_a+'>'+pValue.text_a+'</td>';
                    html += '</tr>';
                    before = pValue.dept_nm;
                }

            });
            $.each(pResult.extra, function(pIndex, pValue){
                if(pValue.ordr == '-1'){
                    $("#rpt7").find("#todo tbody[role=top] th").eq(1).html(pValue.text_m);
                    $("#rpt7").find("#todo tbody[role=top] th").eq(2).html(pValue.text_a);
                    var sn_m = parseInt(pValue.sn_m);
                    var sn_a = parseInt(pValue.sn_a);
                    var update_m = ' ';
                    if(sn_m != 0){
                        $("#rpt7").find("#todo tbody[role=top] th").eq(1).data('sn', sn_m);
                    }
                    else{
                    	$("#rpt7").find("#todo tbody[role=top] th").eq(1).data('sn', '-1');
					}
                    var update_a = ' ';
                    if(sn_a != 0){
                        $("#rpt7").find("#todo tbody[role=top] th").eq(2).data('sn', sn_a);
                    }
                    else{
                        $("#rpt7").find("#todo tbody[role=top] th").eq(2).data('sn', '-1');

					}

                }
                else{
                    $("#rpt7").find("#todo tbody[role=foot] th").eq(1).html(pValue.text_m);
                    $("#rpt7").find("#todo tbody[role=foot] th").eq(2).html(pValue.text_a);
                    var sn_m = parseInt(pValue.sn_m);
                    var sn_a = parseInt(pValue.sn_a);
                    var update_m = ' ';
                    if(sn_m != 0){
                        $("#rpt7").find("#todo tbody[role=foot] th").eq(1).data('sn', sn_m);
                    }
                    else{
                        $("#rpt7").find("#todo tbody[role=foot] th").eq(1).data('sn', '-1');

					}
                    var update_a = ' ';
                    if(sn_a != 0){
                        $("#rpt7").find("#todo tbody[role=foot] th").eq(2).data('sn', sn_a);
                    }
                    else{
                        $("#rpt7").find("#todo tbody[role=foot] th").eq(2).data('sn', '-1');
					}

                }


            });

            $("#rpt7").find("#todo tbody[role=body]").html(html);
            $('#rpt7').find('#todo tbody[role=body]').yRowspan(0);
            $('#rptDate7').html(getWeek($('#s_ddt_man').val()));
		}
	});
}



</script>



<script type="text/javascript">
$(function() {
    /**************************************************************************
     *
     */
	$('#popReport7').on('show.bs.modal', function(pEvent) {
		var modal = $(this);
		if (modal.find('#s_ddt_man').val() == '') {
			modal.find('#s_ddt_man').datepicker('setDate', 'today');
		}
		getTodo(modal.find('#s_ddt_man').val());
	});
	$('#popReport7').on('change', '#s_ddt_man', function(pEvent) {
        getTodo($(this).val());
	});
	$('#popReport7').find('#todo').on('dblclick', 'td[name=todo_text], th[name=todo_text]', function(pEvent) {
        if($(this).data('mber') != $('#loginSN').val()){
            alert("본인 업무만 수정 가능합니다.");
            return false;
        }
        if($(this).data('sn') && parseInt($(this).data('sn')) != -1){
            var todo_sn = $(this).data('sn');
            var todo_text = $(this).html();
            var mber_sn = $(this).data('mber');
            var todo_time = $(this).data('time');
            var inputValue = prompt('업무를 입력하세요.', todo_text);
            if (inputValue != null && inputValue != todo_text) {
                $(this).html(inputValue);
                updateTodo(todo_sn, mber_sn, todo_time, inputValue);
            }
        }
        else{
            var todo_text = $(this).html();
            var mber_sn = $(this).data('mber');
            var todo_time = $(this).data('time');
            var inputValue = prompt('업무를 입력하세요.', todo_text);
            if (inputValue != null && inputValue != todo_text) {
                $(this).html(inputValue);
                insertTodo(mber_sn, todo_time, inputValue);
            }
        }
	});
!function(e,t){"use strict";var n=null,a="ontouchstart"in e||navigator.MaxTouchPoints>0||navigator.msMaxTouchPoints>0,i=a?"touchstart":"mousedown",o=a?"touchend":"mouseup",m=a?"touchmove":"mousemove",u=0,r=0,s=10,c=10;function l(i){v(i);var m=i.target,u=parseInt(m.getAttribute("data-long-press-delay")||"750",10);n=function(t,n){if(!(e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame&&e.mozCancelRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame))return e.setTimeout(t,n);var a=(new Date).getTime(),i={},o=function(){(new Date).getTime()-a>=n?t.call():i.value=requestAnimFrame(o)};return i.value=requestAnimFrame(o),i}(function(e){v();var n=a?e.touches[0].clientX:e.clientX,i=a?e.touches[0].clientY:e.clientY;this.dispatchEvent(new CustomEvent("long-press",{bubbles:!0,cancelable:!0,detail:{clientX:n,clientY:i}}))&&t.addEventListener(o,function e(n){t.removeEventListener(o,e,!0),function(e){e.stopImmediatePropagation(),e.preventDefault(),e.stopPropagation()}(n)},!0)}.bind(m,i),u)}function v(t){var a;(a=n)&&(e.cancelAnimationFrame?e.cancelAnimationFrame(a.value):e.webkitCancelAnimationFrame?e.webkitCancelAnimationFrame(a.value):e.webkitCancelRequestAnimationFrame?e.webkitCancelRequestAnimationFrame(a.value):e.mozCancelRequestAnimationFrame?e.mozCancelRequestAnimationFrame(a.value):e.oCancelRequestAnimationFrame?e.oCancelRequestAnimationFrame(a.value):e.msCancelRequestAnimationFrame?e.msCancelRequestAnimationFrame(a.value):clearTimeout(a)),n=null}"function"!=typeof e.CustomEvent&&(e.CustomEvent=function(e,n){n=n||{bubbles:!1,cancelable:!1,detail:void 0};var a=t.createEvent("CustomEvent");return a.initCustomEvent(e,n.bubbles,n.cancelable,n.detail),a},e.CustomEvent.prototype=e.Event.prototype),e.requestAnimFrame=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.oRequestAnimationFrame||e.msRequestAnimationFrame||function(t){e.setTimeout(t,1e3/60)},t.addEventListener(o,v,!0),t.addEventListener(m,function(e){var t=Math.abs(u-e.clientX),n=Math.abs(r-e.clientY);(t>=s||n>=c)&&v()},!0),t.addEventListener("wheel",v,!0),t.addEventListener("scroll",v,!0),t.addEventListener(i,function(e){u=e.clientX,r=e.clientY,l(e)},!0)}(window,document);

      $( document ).on( "long-press", "#popReport7 td[name=todo_text], #popReport7 th[name=todo_text]", function( event ){
        var year = $("#s_year").val();
        var row = $( event.target ).parent().attr('id');
        if($( event.target ).data('mber') != $('#loginSN').val()){
            alert("본인 업무만 수정 가능합니다.");
            return false;
        }
        if($( event.target ).data('sn') && parseInt($(event.target).data('sn')) != -1){
            var todo_sn = $( event.target ).data('sn');
            var todo_text = $( event.target ).html();
            var mber_sn = $( event.target ).data('mber');
            var todo_time = $( event.target ).data('time');
            var inputValue = prompt('업무를 입력하세요.', todo_text);
            if (inputValue != null && inputValue != todo_text) {
                $( event.target ).html(inputValue);
                updateTodo(todo_sn, mber_sn, todo_time, inputValue);
            }
        }
        else{
            var todo_text = $( event.target ).html();
            var mber_sn = $( event.target ).data('mber');
            var todo_time = $( event.target ).data('time');
            var inputValue = prompt('업무를 입력하세요.', todo_text);
            if (inputValue != null && inputValue != todo_text) {
                $( event.target ).html(inputValue);
                insertTodo(mber_sn, todo_time, inputValue);
            }
        }
      });


    $('#popReport7').find('#todo').on('dblclick', 'th[name=todo_head], th[name=todo_foot]', function(pEvent) {
    	console.log($(this).data('sn'));
        if($(this).data('sn') && parseInt($(this).data('sn')) != -1){
            var todo_sn = $(this).data('sn');
            var todo_text = $(this).html();
            var mber_sn = $(this).data('mber');
            var todo_time = $(this).data('time');
            var inputValue = prompt('업무를 입력하세요.', todo_text);
            if (inputValue != null && inputValue != todo_text) {
                $(this).html(inputValue);
                updateTodo(todo_sn, mber_sn, todo_time, inputValue);
            }
        }
        else{
            var todo_text = $(this).html();
            var mber_sn = $(this).data('mber');
            var todo_time = $(this).data('time');
            var inputValue = prompt('업무를 입력하세요.', todo_text);
            if (inputValue != null && inputValue != todo_text) {
                $(this).html(inputValue);
                insertTodo(mber_sn, todo_time, inputValue);
            }
        }
	});

    /**************************************************************************
     *
     */
	$('#btnPrint7').on('click', function(pEvent) {
		var html = $('#popReport7').find('.modal-body').html();
		$('#_print').contents().find('body>div.report').html('');
		$('#_print').contents().find('body>div.report').html(html);
		parent.frames['_print'].focus();
    	parent.frames['_print'].print();
	});
});
</script>
<!--########################################################################-->
<!--# page layer end                                                       #-->
<!--########################################################################-->

<div class="modal fade" data-backdrop="static" id="popReport1">
    <div class="modal-dialog modal-w1200" style="width:88%!important;">
        <div class="modal-content">
			<div class="modal-header">
				<div class="pull-right" style="margin-right:10px;">
					{% if session['member']['auth_cd'] == 1 %}
					<button type="button" class="btn btn-danger" id="btnDeleteBbs"><i class="fa fa-trash">&nbsp;삭제</i></button>
					{% endif %}

					<button type="button" class="btn btn-primary" id="btnSaveBbs"><i class="fa fa-save">&nbsp;저장</i></button>
					<button type="button" class="btn btn-default" aria-hidden="true" data-dismiss="modal"><i class="fa fa-times">&nbsp;취소</i></button>
				</div>
			</div>
			<div class="modal-body report">

<style>
@media (min-width: 100px) and (max-width: 1024px) {

    #popReport1 div.report table th,
    #popReport1 div.report table td {
        font-size: 8px!important;
        padding: 7px 5px!important;
        line-height: 1.0!important;
    }
}
</style>
				<div id="rpt">

				<!-- 기성 현황 시작 -->
				<table id="bbs" class="table table-bordered w100p">
					<colgroup>
						<col width="20%"/>
						<col width="80%"/>
					</colgroup>
					<thead>
						<tr>
							<th class="colorN" colspan="2">공지사항 작성</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<th class="color-contract middle">분류</th>
							<td class="hasinput">
								<select class="form-control select2" id="bbs_type" name="bbs_type" style="width:100%;">
									<option value=""></option>
									<option value="1">공지사항</option>
									<option value="2">경조사</option>
									<option value="3">뉴스레터</option>
								</select>
							</td>
						</tr>
						<tr>
							<th class="color-contract middle">제목</th>
							<td class="hasinput">
								<input type="text" class="form-control" id="bbs_title" name="bbs_title">
							</td>
						</tr>
						<tr>
							<th class="color-contract middle">내용</th>
							<td class="hasinput">
								<textarea name="bbs_content" id="bbs_content"></textarea>
							</td>
						</tr>
					</tbody>

				</table>
				</div><!-- 기성 현황 끝 -->


			</div><!--modal-body-->
        </div><!--modal-content-->
    </div><!--modal-dialog-->
</div><!--modal-->
<script>
var BBS_TYPE = {1 : "공지사항", 2: "경조사", 3:"뉴스레터"}	;
$(document).ready(function() {
	//여기 아래 부분
	$('#bbs_content').summernote({
		  height: 600,                 // 에디터 높이
	  lang: "ko-KR",
	  // 에디터에 커서 이동 (input창의 autofocus라고 생각하시면 됩니다.)
	  focus : true,
	  toolbar: [
		    // 글꼴 설정
		    ['fontname', ['fontname']],
		    // 글자 크기 설정
		    ['fontsize', ['fontsize']],
		    // 굵기, 기울임꼴, 밑줄,취소 선, 서식지우기
		    ['style', ['bold', 'italic', 'underline','strikethrough', 'clear']],
		    // 글자색
		    ['color', ['forecolor','color']],
		    // 표만들기
		    ['table', ['table']],
		    // 글머리 기호, 번호매기기, 문단정렬
		    ['para', ['ul', 'ol', 'paragraph']],
		    // 줄간격
		    ['height', ['height']],
		    // 코드보기, 확대해서보기, 도움말
		    ['view', ['codeview','fullscreen', 'help']]
		  ],
		  // 추가한 글꼴
		fontNames: ['Arial', 'Arial Black', 'Comic Sans MS', 'Courier New','맑은 고딕','궁서','굴림체','굴림','돋음체','바탕체'],
		 // 추가한 폰트사이즈
		fontSizes: ['8','9','10','11','12','14','16','18','20','22','24','28','30','36','50','72']	});
});
getBBS = function()
{
	$.ajax({
		url: '/api/common/get_bbs_list',
		type: 'GET',
		data: '',
		dataType: 'json',
		contentType: false,
		processData: false,
		success: function(pResult) {
			var html = '';
			$.each(pResult, function(pIndex, pValue){
				html += `<div class="table-tr">
							<div class="table-td">${BBS_TYPE[pValue.bbs_type]}</div>
							<div class="table-td text-left bbs_link" data-sn="${pValue.bbs_sn}">${pValue.bbs_title}</div>
							<div class="table-td">${pValue.reg_nm}</div>
							<div class="table-td">${pValue.reg_date}</div>
						</div>`;
			});
			$(document).find("#approval_status_4").html(html);


		}
	});
}

$(function() {
    /**************************************************************************
     *
     */
	$(document).on("click", ".bbs_link", function(){
		$("#popReport1").data("status", "show");
		var sn = $(this).data("sn");
		$.ajax({
			url : '/api/common/get_bbs',
			method : 'GET',
			data : {"bbs_sn" : sn},
			success : function(pResult){
				$("#popReport1").find("#btnDeleteBbs").data("sn", sn);
				$("#popReport1").find("#bbs_type").yVal(pResult.bbs_type);
				$("#popReport1").find("#bbs_title").val(pResult.bbs_title);
				$("#popReport1").find("#bbs_content").summernote('code', pResult.bbs_content);
				$("#popReport1").modal("show");

			},
			error: function(pResult){
				alert("에러가 발생했습니다.");
			}
		})

	});
	$('#popReport1').on('show.bs.modal', function(pEvent) {
		var status = $(this).data("status");
		if(status == "show"){
			$("#btnSaveBbs").hide();
			$("#popReport1").find("#btnDeleteBbs").show();
			$("#popReport1").find("#bbs_type").attr("readonly", true);
			$("#popReport1").find("#bbs_title").attr("readonly", true);
			$("#popReport1").find("#bbs_content").summernote('disable');
		}
		else{
			$("#popReport1").find("#btnDeleteBbs").data("sn", '');
			$("#popReport1").find("#btnDeleteBbs").hide();
			$("#btnSaveBbs").show();
			$("#popReport1").find("#bbs_type").yVal('');
			$("#popReport1").find("#bbs_title").val('');
			$("#popReport1").find("#bbs_content").summernote('code', '');
			$("#popReport1").find("#bbs_type").attr("readonly", false);
			$("#popReport1").find("#bbs_title").attr("readonly", false);
			$("#popReport1").find("#bbs_content").summernote('enable');
		}
	});
	$('#popReport1').on('hidden.bs.modal', function(pEvent) {
		$("#popReport1").data("status", "insert");
	});


    /**************************************************************************
     *
     */
	$(document).on("click", '#btnDeleteBbs', function(){
		var bbs_sn = $(this).data("sn");
		if(bbs_sn != '' && bbs_sn != undefined){
			if(confirm("정말 삭제하시겠습니까?")){
				$.ajax({
					url : '/api/common/delete_bbs',
					method : 'GET',
					data : {"bbs_sn" : bbs_sn},
					success : function(pResult){
						$("#popReport1").modal("hide");
						getBBS();

					},
					error: function(pResult){
						alert("에러가 발생했습니다.");
					}
				})

			}
		}
	});
	$('#btnSaveBbs').on('click', function(pEvent) {
		var params = {"bbs_type" : $("#popReport1").find("#bbs_type").val(), "bbs_title" : $("#popReport1").find("#bbs_title").val().trim(), "bbs_content" : $("#popReport1").find("#bbs_content").val().trim()};
		if(params["bbs_type"] == ''){
			alert("분류를 선택해주세요.");
			return false;
		}
		if(params["bbs_title"] == ''){
			alert("제목을 입력해주세요.");
			return false;
		}
		if(params["bbs_content"].trim() == ''){
			alert("내용을 입력해주세요.");
			return false;
		}
		$.ajax({
			url : '/api/common/insert_bbs',
			method : 'POST',
			data : params,
			success: function(pResult){
				$("#popReport1").modal("hide");
				getBBS();
			},
			error:function(pResult){
				alert("심각한 오류가 발생했습니다.");
			}
		})
	});
});

</script>

{% endblock %}
