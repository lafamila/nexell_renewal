{% extends 'common/main_base.html' %}
{% block content %}

<link rel="stylesheet" type="text/css" href="/static/nexell/css/smartadmin-nexell-report.css">

<!--########################################################################-->
<!--# page layer start                                                     #-->
<!--########################################################################-->
<!-- 레포트1 레이어 팝업 시작 -->
<div id="popReport">
    <div>
        <div class="modal-content">
			<div class="modal-header">
				<div class="pull-right" style="margin-right:10px;">
					<button class="btn btn-primary" id="btnPrint2"><i class="fa fa-print">&nbsp;출력</i></button>
				</div>
                <div class="pull-right" style="margin-right:10px;">
                    <button type="button" id="buttonAdd" class="btn btn-table btn-warning" title="등록" data-toggle="modal" href="#popBox1" data-action="init" data-actioncontract="insert"><i class="fa fa-plus"></i></button>
                </div>
			</div>
			<div class="modal-body report">

                <style>
                    div.report.report-completed1 table th,
                    div.report.report-completed1 table td {
                        font-size: 12px!important;
                    }

                    div.report.report-completed1 #rptCompletedArea table th,
                    div.report.report-completed1 #rptCompletedArea table td {
                        font-size: 12px!important;
                        padding: 7px 5px!important;
                    }
                    div.report table tbody[role=header] tr:last-child th {
                        border-bottom: black 1px solid !important;
                    }

                    div.report *{
                        font-size:12px !important;
                    }
                    #popReport{
                        font-size: 9px !important;
                        line-height: 1.0 !important;
                    }
                    tr.etc{
                        display:none;
                    }
                    tr.myETC, #eETC{
                        cursor:pointer;
                    }
                </style>
                <table id="rptParnterStatus1">
                    <colgroup>
                        <col width="50">
                        <col width="100">
                        <col width="50">
                        <col width="400">

                        <col width="100">
                        <col width="100">
                        <col width="80">
                        <col width="100">
                        <col width="50">
                        <col width="50">
                        <col width="50">
                        <col width="50">
                        <col width="50">
                        <col width="50">
                        <col width="50">
                        <col width="80">
                        <col width="100">
                        <col width="50">
                        <col width="50">
                        <col width="50">
                        <col width="50">
                        <col width="50">

                    </colgroup>
                    <thead>
                        <tr>
                            <th class="colorN text-center middle" rowspan="2">설계담당자</th>
                            <th class="colorN text-center middle" rowspan="2">구분</th>
                            <th class="colorN text-center middle" rowspan="2">순서</th>
                            <th class="colorN text-center middle" rowspan="2">현장명</th>
                            <th class="colorN text-center middle" rowspan="2">발주처</th>
                            <th class="colorN text-center middle" rowspan="2">담당부서</th>
                            <th class="colorN text-center middle" rowspan="2">프로젝트<br>담당자</th>
                            <th class="colorN text-center middle" colspan="4">설계현황</th>
                            <th class="colorN text-center middle" colspan="5">수주현황</th>
                            <th class="colorN text-center middle" colspan="2">설계사무소현황</th>
                            <th class="colorN text-center middle" colspan="3">스펙인현황</th>
                            <th class="colorN text-center middle" rowspan="2">비고</th>
                        </tr>
                        <tr>
                            <th class="colorN text-center middle">설계기간</th>
                            <th class="colorN text-center middle">최초설계</th>
                            <th class="colorN text-center middle">도면수정</th>
                            <th class="colorN text-center middle">설계견적</th>
                            <th class="colorN text-center middle">수주</th>
                            <th class="colorN text-center middle">MH</th>
                            <th class="colorN text-center middle">진행</th>
                            <th class="colorN text-center middle">낙주</th>
                            <th class="colorN text-center middle">수주달성율</th>
                            <th class="colorN text-center middle">설계사무소</th>
                            <th class="colorN text-center middle">연목표달성율</th>
                            <th class="colorN text-center middle">No</th>
                            <th class="colorN text-center middle">HP</th>
                            <th class="colorN text-center middle">연목표달성율</th>
                        </tr>
                    </thead>
                    <tbody role="body">
                    </tbody>
                </table>
                <!------------------------------------------------------------------------------------------->


			</div><!--modal-body-->
        </div><!--modal-content-->
    </div><!--modal-dialog-->
</div>

<script>
    getBlueprint = function(){
        var params = '';
        $.ajax({
            url: '/api/common/ajax_get_blueprint',
            type: 'GET',
            data: params,
            dataType: 'json',
            contentType: false,
            processData: false,
            success: function (pResult) {
                var html = '';
                if(pResult.length == 0){
                    html += '<tr><td class="text-center" colspan="22">데이터를 등록해주세요.</td></tr>';
                }
                else{
                    var mber_sn = null;
                    var b_type = null;
                    var order = 1;
                    $.each(pResult, function(pIndex, pValue){
                        if(mber_sn == pValue.mber_sn && b_type == pValue.b_type){
                            order++;
                        }
                        else{
                            order = 1;
                        }
                        html += `<tr>
                                    <td class="text-center middle">${pValue.mber_nm}</td>
                                    <td class="text-center middle">${pValue.b_type_nm}</td>
                                    <td class="text-center middle">${order}</td>
                                    <td class="text-center middle">${pValue.spt_nm}</td>
                                    <td class="text-center middle">${pValue.bcnc_nm}</td>
                                    <td class="text-center middle">${pValue.dept_nm}</td>
                                    <td class="text-center middle">${pValue.bsn_mber_nm}</td>`;
                        for(let i=1;i<=14;i++)
                        html += `   <td class="text-center middle input-available" data-column="b_${i}" data-row="${pValue.b_sn}">${pValue['b_'+i]}</td>`
                        html += `</tr>`;
                    });
                }
                $("#rptParnterStatus1").find("tbody").html(html);

            }
        });
    }
    $(document).ready(function(){
        getBlueprint();

    });


	$(function() {
		/**************************************************************************
		 * 인쇄 버튼 클릭 처리
		 */
		$('#btnPrint2').on('click', function(pEvent) {
			var html = $('#popReport').find('.modal-body').html();
			$('#_print').contents().find('body>div.report').html('');
			$('#_print').contents().find('body>div.report').html(html);
			parent.frames['_print'].focus();
			parent.frames['_print'].print();
		});
	});
$(document).on("dblclick", ".input-available", function(){
	var authors = ["*"];
	var loginId = $("#loginID").val();
	if(!authors.includes("*") && !authors.includes(loginId)){
		alert("권한이 없습니다.");
		return false;
	}

	var data = prompt("값을 입력하세요.");
	var td = $(this);
	var rowId = $(this).data("row");
	var column = $(this).data("column");
	var params = '';
	params += '&b_sn='+rowId;
	params += '&column='+column;
	params += '&data='+data;
	$.ajax({
		url: '/api/common/update_blueprint',
		type: 'GET',
		data: params,
		dataType: 'json',
		contentType: false,
		processData: false,
		success: function (pResult) {
            $(td).text(data);
		}
	});

});
</script>

<div class="modal fade" data-backdrop="static" id="popBox1">
    <style type="text/css">
#popBox1 tbody .btnUpdate, #popBox1 tbody .btnPrint{
    line-height: 1.42857143 !important;
    padding: 5px 7px!important;
    margin:  0px !important;
}
#popBox1 tbody{
    font-size:12px!important;
}

    </style>
    <div class="modal-dialog modal-w900" style="width:800px!important" id="approval-tab-container">
        <div class="modal-content">
			<div class="jarviswidget jarviswidget-color-greenDark">
				<header>
					<ul class="nav nav-tabs" id="popEditTabs2">
						<li class="active" data-action="1">
							<a data-toggle="tab" href="#tabBox1" data-action="tab1"><i class="fa fa-lg fa-edit"></i>&nbsp;<span>설계현황 등록</span></a>
						</li>
					</ul>
					<div class="jarviswidget-ctrls" role="menu">
						<a class="button-icon jarviswidget-delete-btn" aria-hidden="true" data-dismiss="modal"><i class="fa fa-times"></i></a>
					</div>

				</header>
				<div role="content" style="min-height:110px;height:auto;">
					<div class="widget-body no-padding" style="height:100%;">
						<div class="tab-content" style="height:100%;">

							<!-- 프로젝트 -->
							<div class="tab-pane fade active in" id="tabBox1" style="height:100%;">
							<form id="frmBox1" style="height:100%;">
								<table class="table table-bordered table-form">
									<colgroup>
										<col width="175">
										<col width="390">
										<col width="60">
									</colgroup>
									<tbody>
										<tr>
											<th class="" style="background:#0070C0;border-color:#0070C0;color:white;border-left:none;padding:0;" colspan="3">
											<span class="widget-toolbar" id="popEditToolbarContract">
												<button type="button" class="btn btn-primary" id="btnSave" title="저장합니다."><i class="fa fa-save"> 저장</i></button>

											</span>
											</th>
										</tr>

										<tr class="required">
											<th class="color-contract">설계담당자</th>
											<td class="hasinput" colspan="2">
												<select class="form-control select2" id="s_mber_sn" name="s_mber_sn" >
													<option value="">[설계담당자를 선택해주세요.]</option>
													{% for code in member_list %}
													<option value="{{code.value}}">{{code.label}} {{code.etc1}}</option>
													{% endfor %}
												</select>
											</td>
										</tr>
										<tr class="required">
											<th class="color-contract">구분</th>
											<td class="hasinput" colspan="2">
												<select class="form-control select2" id="s_b_type" name="s_b_type" >
													<option value="">[구분을 선택해주세요.]</option>
													<option value="0">신규현장</option>
													<option value="1">변경현장</option>
												</select>
											</td>
										</tr>
										<tr class="required">
											<th class="color-contract">현장명</th>
											<td class="hasinput" colspan="2">
												<select class="form-control select2" id="s_cntrct_sn" name="s_cntrct_sn">
													<option value="">[계약을 선택해주세요.]</option>
                                                    {% for code in contract_list %}
                                                    <option value="{{code.value}}">{{code.label}}</option>
                                                    {% endfor %}
												</select>
											</td>
										</tr>
									</tbody>
								</table>

							</form>
							</div><!--tab-pane-->
						</div><!--tab-content-->
					</div><!--widget-body-->
				</div><!--content-->
			</div><!--jarviswidget-->
        </div><!--modal-content-->
    </div><!--modal-dialog-->
</div><!--modal-->

<script>
    var isDataChange = false;

	init = function(){
		$("#popBox1").find("#s_mber_sn").yVal('');
		$("#popBox1").find("#s_b_type").yVal('');
		// $(modal).find("#cntrct_sn").select2('destroy');
		$("#popBox1").find("#s_cntrct_sn").yVal('');

	}
	$(document).on('click', '#btnSave', function(){
		var params = $("#frmBox1").formSerialize();
		if($('#popBox1').find("#s_cntrct_sn").val() == ''){
			alert("계약을 선택해주세요.");
			return false;
		}
		$.ajax({
			url: '/api/common/insert_blueprint',
			type: 'GET',
			data: params,
			dataType: 'json',
			contentType: false,
			processData: false,
			success: function (pResult) {
				console.log(pResult);
				isDataChange = true;
				init();
			}

		});
	});

	$('#popBox1').on('shown.bs.modal', function(pEvent)
	{
		init();
	});

	$('#popBox1').on('hidden.bs.modal', function(pEvent)
	{
		if (isDataChange) {
			location.reload();
			isDataChange = false;
		}
	});

</script>

{% endblock %}
